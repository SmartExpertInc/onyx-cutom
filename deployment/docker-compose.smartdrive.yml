version: '3.8'

services:
  # SmartDrive backend extension (if needed as separate service)
  smartdrive-backend:
    build:
      context: ../custom_extensions/backend
      dockerfile: Dockerfile
    container_name: onyx-smartdrive-backend
    restart: unless-stopped
    environment:
      # External Nextcloud Configuration
      - NEXTCLOUD_BASE_URL=${NEXTCLOUD_EXTERNAL_URL}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-admin}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      
      # Encryption for connector credentials
      - ENCRYPTION_PASSWORD=${ENCRYPTION_PASSWORD}
      - ENCRYPTION_SALT=${ENCRYPTION_SALT}
      
      # Onyx Integration
      - ONYX_API_BASE_URL=${ONYX_API_BASE_URL:-http://api:8080/api}
      - ONYX_API_KEY=${ONYX_API_KEY}
      
      # Webhook Security
      - NEXTCLOUD_WEBHOOK_SECRET=${NEXTCLOUD_WEBHOOK_SECRET}
      
      # Database connection (use main Onyx DB or separate)
      - DATABASE_URL=${SMARTDRIVE_DATABASE_URL:-${DATABASE_URL}}
    networks:
      - onyx-network
    depends_on:
      - api  # Depends on main Onyx API
    labels:
      - "com.docker.compose.service=smartdrive-backend"

networks:
  onyx-network:
    external: true
    name: onyx-network 