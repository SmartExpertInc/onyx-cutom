version: '3.8'

services:
  app:
    image: mcr.microsoft.com/devcontainers/base:ubuntu
    container_name: onyx-codespaces-app
    restart: unless-stopped
    working_dir: /workspaces/onyx-cutom
    volumes:
      - ..:/workspaces/onyx-cutom:cached
    command: sleep infinity
    environment:
      - WEB_DOMAIN=${WEB_DOMAIN:-localhost:8088}
      - WEB_DOMAIN_NO_PROTOCOL=${WEB_DOMAIN_NO_PROTOCOL:-localhost:8088}
    ports:
      - "8080:8080"  # API Server
      - "8088:8088"  # Nginx (main web interface)
      - "5432:5432"  # PostgreSQL
      - "5433:5433"  # Custom Projects DB
      - "6379:6379"  # Redis
      - "19071:19071" # Vespa Admin
      - "8081:8081"  # Vespa Application
      - "9000:9000"  # Model Server

  # Development database for Codespaces
  dev-db:
    image: postgres:15.2-alpine
    container_name: onyx-codespaces-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: onyx_db
    ports:
      - "5432:5432"
    volumes:
      - dev_db_volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d onyx_db || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Development Redis for Codespaces
  dev-redis:
    image: redis:7.4-alpine
    container_name: onyx-codespaces-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --save "" --appendonly no

  # Development Vespa for Codespaces
  dev-vespa:
    image: vespaengine/vespa:8.277.17
    container_name: onyx-codespaces-vespa
    restart: unless-stopped
    ports:
      - "19071:19071"
      - "8081:8081"
    volumes:
      - dev_vespa_volume:/opt/vespa/var

volumes:
  dev_db_volume:
  dev_vespa_volume: 