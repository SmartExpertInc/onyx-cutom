"use client";
// @ts-nocheck

import React, { useState, useRef, useEffect, Suspense } from "react";
import Link from "next/link";
import { ArrowLeft, Shuffle, Sparkles, Plus, FileText, ChevronDown, Search, FolderIcon, Globe, FileQuestion, MessageCircleQuestion, PanelsLeftBottom, Paintbrush, ClipboardList, Network, RulerDimensionLine } from "lucide-react";
import { useRouter, useSearchParams } from "next/navigation";
import { useLanguage } from "../../../contexts/LanguageContext";
import { generatePromptId } from "../../../utils/promptUtils";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { GenerateCard } from "@/components/ui/generate-card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue, CustomPillSelector, CustomMultiSelector } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { HeadTextCustom } from "@/components/ui/head-text-custom";

// Inline SVG icon components
const CourseOutlineIcon: React.FC<{ size?: number }> = ({ size = 35 }) => (
<svg width={size} height={size} viewBox="0 0 73 67" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.25649 20.6648H26.5076C26.8489 20.658 27.174 20.5176 27.413 20.2738C27.652 20.0299 27.7858 19.7021 27.7858 19.3607C27.7858 19.0193 27.6519 18.6915 27.4129 18.4477C27.1739 18.2038 26.8488 18.0635 26.5075 18.0566H6.25649C5.91513 18.0635 5.59007 18.2039 5.35107 18.4477C5.11208 18.6915 4.97821 19.0193 4.97821 19.3607C4.97821 19.7022 5.11208 20.03 5.35107 20.2738C5.59007 20.5176 5.91513 20.658 6.25649 20.6648Z" fill="#B7CDFD"/>
  <path d="M70.9108 9.66609L54.0823 1.24553C53.5578 0.984798 52.9809 0.846783 52.3952 0.841929C51.8095 0.837076 51.2304 0.965513 50.7017 1.21752L34.0675 9.22419C33.5268 9.48319 33.0549 9.86616 32.6902 10.3419C32.3255 10.8177 32.0782 11.3729 31.9685 11.9623H7.2532C5.33034 11.9646 3.48689 12.7294 2.12723 14.0891C0.76756 15.4487 0.00270164 17.2922 0.000427246 19.2151V59.3084C0.00270165 61.2313 0.767561 63.0747 2.12723 64.4344C3.48689 65.7941 5.33034 66.5589 7.2532 66.5612H59.6012C61.524 66.5589 63.3675 65.7941 64.7271 64.4344C66.0868 63.0747 66.8517 61.2313 66.8539 59.3084V29.6293C67.7361 28.6868 68.2332 27.448 68.2472 26.1571V17.8584L70.9115 16.5254C71.5409 16.2004 72.0687 15.7085 72.4372 15.1035C72.8056 14.4986 73.0005 13.8039 73.0004 13.0955C73.0004 12.3872 72.8054 11.6925 72.4368 11.0876C72.0682 10.4827 71.5403 9.99092 70.9108 9.66609ZM7.2532 14.5705H32.3947C33.0104 15.9058 35.4859 16.8202 36.6783 17.5168L36.6782 24.1449H2.60862V19.2151C2.61 17.9837 3.09978 16.8031 3.97051 15.9324C4.84124 15.0616 6.0218 14.5719 7.2532 14.5705ZM59.6012 63.953H7.2532C6.0218 63.9516 4.84124 63.4618 3.97051 62.5911C3.09978 61.7204 2.61 60.5398 2.60862 59.3084V26.7531H36.7189C36.996 30.9036 45.3236 36.5312 51.8439 36.5874C56.3987 36.5651 60.7962 34.9186 64.2457 31.9441V59.3084C64.2443 60.5398 63.7545 61.7204 62.8838 62.5911C62.0131 63.4618 60.8326 63.9516 59.6012 63.953ZM65.639 26.1571C65.6354 26.5011 65.5627 26.841 65.4253 27.1564C65.288 27.4719 65.0886 27.7565 64.8392 27.9935C60.5881 32.0765 56.2473 34.1319 51.9116 33.9791C46.0348 33.8276 41.5787 29.7421 39.9365 27.9935C39.6572 27.6366 39.4552 27.2256 39.3433 26.7865C39.2314 26.3473 39.212 25.8897 39.2865 25.4427L39.2864 18.8938L50.6259 24.881C51.1655 25.1653 51.765 25.3172 52.3748 25.3241C52.9847 25.331 53.5874 25.1926 54.1333 24.9205L65.639 19.1634V26.1571ZM69.7442 14.1922C67.64 15.241 55.3498 21.3976 52.966 22.5874C52.7917 22.6748 52.5989 22.7193 52.4038 22.7171C52.2088 22.7149 52.017 22.666 51.8447 22.5746L35.157 13.7631C34.9582 13.6556 34.7928 13.4955 34.679 13.3003C34.5651 13.1051 34.5071 12.8824 34.5114 12.6565C34.5157 12.4306 34.5821 12.2102 34.7032 12.0194C34.8244 11.8287 34.9957 11.675 35.1984 11.5751L51.8326 3.56842C52.0016 3.48748 52.1869 3.4462 52.3743 3.44775C52.5616 3.44929 52.7462 3.49362 52.9138 3.57734L69.7442 11.9992C69.9459 12.1027 70.1152 12.2598 70.2334 12.4532C70.3515 12.6467 70.4141 12.869 70.4141 13.0957C70.4141 13.3224 70.3515 13.5447 70.2334 13.7382C70.1152 13.9316 69.9459 14.0888 69.7442 14.1922Z" fill="#B7CDFD"/>
  <path d="M19.2734 30.2334H11.3883C10.6968 30.2342 10.0338 30.5092 9.54489 30.9982C9.05593 31.4872 8.78088 32.1501 8.78009 32.8416V40.7273C8.78088 41.4188 9.05593 42.0818 9.54489 42.5707C10.0338 43.0597 10.6968 43.3347 11.3883 43.3355H19.2734C19.9649 43.3347 20.6278 43.0597 21.1168 42.5707C21.6057 42.0817 21.8808 41.4188 21.8816 40.7273V32.8416C21.8808 32.1501 21.6057 31.4872 21.1168 30.9982C20.6278 30.5092 19.9649 30.2342 19.2734 30.2334ZM11.3883 40.7273V32.8416H19.2734L19.2747 40.7273H11.3883Z" fill="#B7CDFD"/>
  <path d="M26.876 34.7684H32.5037C32.8452 34.7617 33.1704 34.6214 33.4095 34.3775C33.6487 34.1337 33.7826 33.8057 33.7826 33.4642C33.7826 33.1227 33.6486 32.7948 33.4095 32.5509C33.1703 32.3071 32.8451 32.1668 32.5036 32.1602H26.876C26.5345 32.1668 26.2093 32.3071 25.9701 32.551C25.731 32.7948 25.597 33.1227 25.597 33.4643C25.597 33.8058 25.731 34.1337 25.9701 34.3775C26.2093 34.6214 26.5345 34.7617 26.876 34.7684Z" fill="#B7CDFD"/>
  <path d="M26.876 41.409H42.3271C42.6686 41.4023 42.9938 41.262 43.2329 41.0181C43.4721 40.7743 43.606 40.4464 43.606 40.1048C43.606 39.7633 43.472 39.4354 43.2329 39.1916C42.9937 38.9477 42.6685 38.8074 42.327 38.8008H26.876C26.5345 38.8074 26.2093 38.9478 25.9701 39.1916C25.731 39.4354 25.597 39.7633 25.597 40.1049C25.597 40.4464 25.731 40.7743 25.9701 41.0182C26.2093 41.262 26.5345 41.4023 26.876 41.409Z" fill="#B7CDFD"/>
  <path d="M19.2734 49.0391H11.3883C10.6968 49.0399 10.0338 49.3149 9.54489 49.8039C9.05593 50.2928 8.78088 50.9558 8.78009 51.6473V59.5317C8.78088 60.2232 9.05593 60.8862 9.54489 61.3751C10.0338 61.8641 10.6968 62.1391 11.3883 62.1399H19.2734C19.9649 62.1391 20.6278 61.8641 21.1168 61.3751C21.6057 60.8861 21.8808 60.2232 21.8816 59.5317V51.6473C21.8808 50.9558 21.6057 50.2928 21.1168 49.8039C20.6278 49.3149 19.9649 49.0399 19.2734 49.0391ZM11.3883 59.5317V51.6473H19.2734L19.2753 59.5317H11.3883Z" fill="#B7CDFD"/>
  <path d="M48.7208 50.9658H26.8759C26.5345 50.9725 26.2092 51.1128 25.9701 51.3567C25.731 51.6005 25.597 51.9284 25.597 52.27C25.5971 52.6115 25.731 52.9394 25.9702 53.1832C26.2093 53.4271 26.5346 53.5674 26.876 53.574H48.7208C49.0622 53.5672 49.3873 53.4268 49.6263 53.183C49.8653 52.9391 49.9991 52.6113 49.9991 52.2699C49.9991 51.9285 49.8653 51.6007 49.6263 51.3569C49.3873 51.113 49.0622 50.9726 48.7208 50.9658Z" fill="#B7CDFD"/>
  <path d="M40.8498 57.6045H26.8759C26.5345 57.6112 26.2092 57.7515 25.9701 57.9953C25.731 58.2392 25.597 58.5671 25.597 58.9086C25.5971 59.2502 25.731 59.5781 25.9702 59.8219C26.2093 60.0657 26.5345 60.206 26.876 60.2127H40.8498C41.1912 60.206 41.5165 60.0657 41.7556 59.8219C41.9947 59.578 42.1287 59.2501 42.1287 58.9086C42.1287 58.5671 41.9947 58.2392 41.7556 57.9953C41.5165 57.7515 41.1912 57.6111 40.8498 57.6045Z" fill="#B7CDFD"/>
</svg>
);

const LessonPresentationIcon: React.FC<{ size?: number }> = ({ size = 35 }) => (
<svg width={size} height={size} viewBox="0 0 71 74" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M30.5255 37.2917C31.2184 38.0189 32.1702 38.4433 33.1742 38.4728C34.1782 38.5022 35.1532 38.1343 35.8875 37.4489L45.248 28.0878C48.2455 24.957 43.4323 20.2303 40.362 23.2008L33.3147 30.2494C32.0593 29.1592 30.1189 26.3732 28.2341 26.4672C27.5308 26.438 26.8352 26.6229 26.2392 26.9975C25.6433 27.3722 25.1751 27.9189 24.8967 28.5654C24.6182 29.2119 24.5426 29.9277 24.6798 30.6181C24.8171 31.3086 25.1606 31.9411 25.6651 32.432L30.5255 37.2917ZM27.3812 29.5186C27.4433 29.399 27.5338 29.2965 27.6447 29.2199C27.7557 29.1434 27.8836 29.0951 28.0175 29.0795C28.1514 29.0638 28.287 29.0811 28.4127 29.1299C28.5383 29.1788 28.6501 29.2576 28.7382 29.3596L32.393 33.0144C32.6421 33.2499 32.9719 33.3811 33.3146 33.3811C33.6574 33.3811 33.9872 33.2499 34.2363 33.0144L42.2054 25.0453C42.7878 24.4708 44.0228 25.5532 43.4046 26.2439L34.0441 35.6056C33.9238 35.7055 33.7851 35.7806 33.6357 35.8268C33.4864 35.8729 33.3295 35.8892 33.1738 35.8746C33.0182 35.86 32.867 35.8148 32.7289 35.7417C32.5907 35.6686 32.4684 35.569 32.3688 35.4485L27.5085 30.5886C27.3524 30.4617 27.2519 30.2791 27.2281 30.0794C27.2043 29.8797 27.2592 29.6786 27.3812 29.5186Z" fill="#B7CDFD"/>
  <path d="M35.3916 46.7594C39.7338 46.7544 43.8966 45.0272 46.9669 41.9568C50.0372 38.8864 51.7642 34.7234 51.769 30.3813C50.8695 8.65358 19.9104 8.65989 19.0142 30.3814C19.019 34.7236 20.746 38.8865 23.8163 41.9569C26.8866 45.0273 31.0495 46.7544 35.3916 46.7594ZM35.3916 16.6105C39.0426 16.6145 42.5428 18.0667 45.1244 20.6484C47.706 23.2301 49.158 26.7304 49.1619 30.3814C48.4061 48.6505 22.3744 48.6451 21.6213 30.3813C21.6252 26.7303 23.0773 23.23 25.6588 20.6483C28.2404 18.0667 31.7406 16.6145 35.3916 16.6105Z" fill="#B7CDFD"/>
  <path d="M68.1757 0.0644531H2.60763C1.91642 0.0652432 1.25374 0.340177 0.764975 0.82894C0.276212 1.3177 0.00127837 1.98038 0.000488281 2.6716V6.76181C0.00128181 7.45303 0.276217 8.1157 0.764979 8.60446C1.25374 9.09323 1.91642 9.36816 2.60763 9.36896H3.41472V51.3939C3.23648 51.3626 3.05368 51.3684 2.8778 51.4111C2.70192 51.4537 2.53675 51.5323 2.39265 51.6418C2.24855 51.7512 2.12863 51.8893 2.04041 52.0473C1.9522 52.2054 1.89758 52.3799 1.87999 52.56C1.86241 52.7402 1.88223 52.922 1.93822 53.0941C1.99421 53.2662 2.08515 53.4248 2.20535 53.5601C2.32555 53.6954 2.47241 53.8044 2.63672 53.8803C2.80102 53.9562 2.97924 53.9973 3.16018 54.001H4.7183H28.1826C28.1678 54.1189 28.1792 56.1357 28.2047 56.152L17.3097 69.1888C17.0287 69.5363 16.8512 69.956 16.7977 70.3998C16.7441 70.8435 16.8166 71.2934 17.0069 71.6978C17.1971 72.1023 17.4974 72.445 17.8734 72.6867C18.2494 72.9284 18.6858 73.0593 19.1328 73.0645C20.3886 72.952 22.6863 73.3604 23.5233 72.1562L31.9851 62.121V70.5636C31.9859 71.19 32.235 71.7905 32.678 72.2335C33.1209 72.6764 33.7214 72.9256 34.3478 72.9264H36.4661C37.0925 72.9256 37.693 72.6764 38.136 72.2335C38.5789 71.7905 38.8281 71.19 38.8288 70.5636V62.1627L47.2677 72.1676C47.4846 72.4186 47.751 72.6222 48.0502 72.7654C48.3495 72.9087 48.6751 72.9886 49.0066 73.0001C51.6214 73.0645 51.6405 73.0645 51.6596 73.0645C49.0066 73.0002 51.6023 73.0638 51.6023 73.0638C52.0531 73.067 52.4955 72.942 52.878 72.7036C53.2606 72.4651 53.5675 72.1229 53.7632 71.7168C53.9588 71.3107 54.0351 70.8574 53.9831 70.4096C53.9312 69.9618 53.7532 69.538 53.4697 69.1874L42.6037 56.1803C42.6694 56.1657 42.6128 54.0852 42.6314 54.001H66.0651H67.6525C67.8349 53.997 68.0144 53.9551 68.1797 53.878C68.345 53.8008 68.4925 53.6902 68.6128 53.5531C68.7331 53.416 68.8235 53.2553 68.8784 53.0814C68.9334 52.9075 68.9515 52.724 68.9318 52.5427C68.912 52.3613 68.8548 52.1861 68.7637 52.028C68.6727 51.87 68.5497 51.7326 68.4028 51.6246C68.2558 51.5166 68.0879 51.4403 67.9099 51.4006C67.7319 51.3609 67.5475 51.3586 67.3686 51.3939V9.36894H68.1757C68.8669 9.36815 69.5296 9.09321 70.0183 8.60445C70.5071 8.11569 70.782 7.45301 70.7828 6.7618V2.6716C70.782 1.98039 70.5071 1.31772 70.0184 0.828959C69.5296 0.340197 68.8669 0.065257 68.1757 0.0644531ZM21.5973 70.3968L19.6585 70.4446L29.8615 58.2356C30.4887 58.3446 31.1264 58.3801 31.7618 58.3413L21.5973 70.3968ZM34.5923 70.3192V58.3414H36.2116L36.2217 70.3192H34.5923ZM49.1849 70.3968L39.0166 58.3414C39.6555 58.3829 40.2971 58.3495 40.9283 58.2418L51.1224 70.4446L49.1849 70.3968ZM40.0242 55.7343C39.1615 55.7312 30.7897 55.7343 30.7897 55.7343V54.001H40.0242V55.7343ZM64.7615 51.3939C47.9573 51.3913 22.8234 51.3947 6.02182 51.3939V9.36899H64.7615V51.3939ZM2.60763 6.76181V2.6716H68.1757L68.177 6.76181H2.60763Z" fill="#B7CDFD"/>
</svg>
);

const QuizIcon: React.FC<{ size?: number }> = ({ size = 35 }) => (
<svg width={size} height={size} viewBox="0 0 73 74" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M72.3605 16.0536C72.0963 15.2385 71.6732 14.484 71.1155 13.8335C70.5579 13.183 69.8769 12.6495 69.1118 12.2638L53.7029 4.4438L51.1724 1.72574C50.684 1.20251 50.0934 0.785097 49.4371 0.499341C48.7809 0.213586 48.0729 0.0655693 47.3572 0.0644531H18.0994C16.3714 0.0664817 14.7147 0.753834 13.4928 1.97573C12.2709 3.19763 11.5836 4.85429 11.5815 6.58231V30.6483L0.694669 52.0991C-0.0788935 53.6432 -0.211684 55.4303 0.325166 57.0718C0.862015 58.7133 2.0251 60.0765 3.56159 60.8651L11.5815 64.9354V66.5466C11.5836 68.2746 12.2709 69.9313 13.4928 71.1532C14.7147 72.3751 16.3714 73.0624 18.0994 73.0645H54.5739C56.3019 73.0624 57.9586 72.3751 59.1805 71.1532C60.4024 69.9313 61.0897 68.2746 61.0918 66.5466V42.4931L71.9786 21.0298C72.3684 20.2669 72.6029 19.4342 72.6685 18.58C72.734 17.7258 72.6294 16.867 72.3605 16.0536ZM58.0998 13.0722H51.2679C50.5767 13.0713 49.9141 12.7963 49.4254 12.3076C48.9366 11.8188 48.6617 11.1562 48.6608 10.465V3.03759C48.8807 3.16536 58.0092 12.9244 58.0998 13.0722ZM4.74161 58.5406C3.81943 58.0672 3.12127 57.2491 2.79878 56.264C2.47629 55.2788 2.55552 54.2062 3.01925 53.2792L11.5815 36.4076V62.0124L4.74161 58.5406ZM54.5739 70.4573H18.0994C17.0626 70.4562 16.0685 70.0438 15.3354 69.3106C14.6022 68.5775 14.1898 67.5834 14.1887 66.5466V6.58231C14.1898 5.54547 14.6022 4.55142 15.3354 3.81827C16.0685 3.08511 17.0626 2.67273 18.0994 2.6716H46.0536V10.465C46.055 11.8475 46.6048 13.173 47.5824 14.1506C48.5599 15.1281 49.8854 15.6779 51.2679 15.6793H58.4846V66.5466C58.4835 67.5834 58.0711 68.5775 57.338 69.3106C56.6048 70.0438 55.6108 70.4562 54.5739 70.4573ZM69.6541 19.8497L61.0918 36.7312V14.4305C61.0528 13.5745 60.8341 12.7363 60.4499 11.9704C60.0657 11.2045 59.5246 10.5281 58.8617 9.98507L67.9317 14.5883C68.857 15.0585 69.558 15.8765 69.8809 16.8629C70.2038 17.8492 70.1222 18.9234 69.6541 19.8497Z" fill="#D997FF"/>
  <path d="M26.1483 15.1337C25.4462 14.9725 24.7169 14.9711 24.0142 15.1293C23.3115 15.2876 22.6533 15.6016 22.0881 16.0482C21.5229 16.4947 21.0652 17.0625 20.7487 17.7095C20.4322 18.3566 20.2649 19.0664 20.2593 19.7867C20.2593 20.1324 20.3966 20.464 20.6411 20.7084C20.8856 20.9529 21.2171 21.0903 21.5628 21.0903C21.9086 21.0903 22.2401 20.9529 22.4846 20.7084C22.7291 20.464 22.8664 20.1324 22.8664 19.7867C22.8658 19.3982 22.9693 19.0167 23.1661 18.6817C23.3628 18.3468 23.6457 18.0706 23.9854 17.882C24.325 17.6934 24.7089 17.5992 25.0973 17.6092C25.4856 17.6192 25.8642 17.7331 26.1936 17.9389C26.5231 18.1448 26.7914 18.4351 26.9706 18.7798C27.1499 19.1244 27.2336 19.5108 27.213 19.8987C27.1923 20.2866 27.0682 20.662 26.8534 20.9857C26.6387 21.3094 26.3411 21.5697 25.9917 21.7394C25.3268 22.0458 24.7621 22.5339 24.3627 23.1475C23.9633 23.7611 23.7456 24.4751 23.7346 25.2071V26.7385C23.7346 27.0842 23.8719 27.4158 24.1164 27.6603C24.3609 27.9047 24.6924 28.0421 25.0382 28.0421C25.3839 28.0421 25.7155 27.9047 25.9599 27.6603C26.2044 27.4158 26.3417 27.0842 26.3417 26.7385V25.2071C26.3533 24.9635 26.4343 24.7283 26.575 24.5292C26.7157 24.3301 26.9104 24.1753 27.1361 24.083C28.0107 23.642 28.7296 22.9442 29.1965 22.0832C29.6635 21.2222 29.8561 20.239 29.7486 19.2654C29.6412 18.2919 29.2387 17.3744 28.5953 16.6359C27.9518 15.8975 27.098 15.3733 26.1483 15.1337Z" fill="#D997FF"/>
  <path d="M26.3418 31.3142C26.3353 30.9727 26.1951 30.6475 25.9513 30.4083C25.7075 30.1691 25.3797 30.0351 25.0382 30.0352C24.6966 30.0352 24.3688 30.1692 24.125 30.4084C23.8813 30.6475 23.7411 30.9728 23.7346 31.3143C23.7411 31.6557 23.8813 31.981 24.1251 32.2202C24.3688 32.4593 24.6967 32.5933 25.0382 32.5933C25.3797 32.5933 25.7076 32.4593 25.9514 32.2201C26.1951 31.9809 26.3353 31.6556 26.3418 31.3142Z" fill="#D997FF"/>
  <path d="M26.1483 39.3336C25.4461 39.1727 24.7168 39.1713 24.0141 39.3298C23.3114 39.4882 22.6532 39.8023 22.088 40.249C21.5229 40.6957 21.0652 41.2635 20.7487 41.9106C20.4322 42.5576 20.2649 43.2675 20.2593 43.9879C20.2593 44.3336 20.3966 44.6651 20.6411 44.9096C20.8856 45.1541 21.2172 45.2914 21.5629 45.2914C21.9086 45.2914 22.2402 45.154 22.4846 44.9096C22.7291 44.6651 22.8664 44.3335 22.8664 43.9878C22.8658 43.5993 22.9693 43.2178 23.1661 42.8828C23.3628 42.5479 23.6457 42.2717 23.9854 42.0831C24.325 41.8945 24.7089 41.8003 25.0973 41.8103C25.4856 41.8204 25.8642 41.9342 26.1936 42.1401C26.5231 42.3459 26.7914 42.6362 26.9706 42.9809C27.1499 43.3255 27.2336 43.7119 27.213 44.0998C27.1923 44.4878 27.0682 44.8631 26.8534 45.1868C26.6387 45.5105 26.3411 45.7708 25.9917 45.9405C25.3268 46.2469 24.762 46.7351 24.3627 47.3487C23.9633 47.9623 23.7456 48.6763 23.7346 49.4083V50.9397C23.7346 51.2855 23.8719 51.617 24.1164 51.8615C24.3609 52.106 24.6924 52.2433 25.0382 52.2433C25.3839 52.2433 25.7155 52.106 25.9599 51.8615C26.2044 51.617 26.3417 51.2855 26.3417 50.9397V49.4083C26.3533 49.1647 26.4343 48.9295 26.575 48.7304C26.7157 48.5313 26.9104 48.3765 27.1361 48.2842C28.0107 47.843 28.7296 47.1452 29.1965 46.284C29.6634 45.4229 29.856 44.4397 29.7485 43.4661C29.6411 42.4924 29.2387 41.5749 28.5952 40.8363C27.9518 40.0977 27.098 39.5734 26.1483 39.3336Z" fill="#D997FF"/>
  <path d="M25.0385 54.2119C24.6972 54.2186 24.3721 54.3589 24.133 54.6026C23.894 54.8464 23.7601 55.1741 23.7601 55.5155C23.7601 55.8569 23.8941 56.1847 24.1331 56.4284C24.3721 56.6722 24.6973 56.8124 25.0386 56.8191C25.3799 56.8124 25.705 56.6721 25.944 56.4284C26.1831 56.1846 26.317 55.8568 26.3169 55.5155C26.3169 55.1741 26.183 54.8463 25.944 54.6026C25.7049 54.3588 25.3798 54.2186 25.0385 54.2119Z" fill="#D997FF"/>
  <path d="M51.1099 20.1377H35.4671C35.1258 20.1444 34.8007 20.2846 34.5616 20.5284C34.3226 20.7721 34.1887 21.0999 34.1887 21.4413C34.1887 21.7827 34.3226 22.1105 34.5617 22.3542C34.8007 22.5979 35.1258 22.7382 35.4672 22.7448H51.1099C51.4513 22.7382 51.7764 22.5979 52.0154 22.3542C52.2545 22.1104 52.3883 21.7827 52.3883 21.4413C52.3883 21.0999 52.2545 20.7721 52.0154 20.5284C51.7764 20.2846 51.4513 20.1443 51.1099 20.1377Z" fill="#D997FF"/>
  <path d="M35.4671 28.7898H48.8135C49.1548 28.7831 49.4799 28.6428 49.7189 28.3991C49.9579 28.1553 50.0918 27.8275 50.0918 27.4861C50.0918 27.1448 49.9579 26.817 49.7189 26.5732C49.4798 26.3295 49.1547 26.1893 48.8134 26.1826H35.4671C35.1258 26.1893 34.8007 26.3295 34.5617 26.5733C34.3226 26.817 34.1887 27.1448 34.1887 27.4862C34.1887 27.8276 34.3226 28.1553 34.5617 28.3991C34.8007 28.6428 35.1258 28.7831 35.4671 28.7898Z" fill="#D997FF"/>
  <path d="M51.1099 44.3389H35.4671C35.1258 44.3455 34.8007 44.4858 34.5616 44.7296C34.3226 44.9733 34.1887 45.3011 34.1887 45.6425C34.1887 45.9839 34.3226 46.3116 34.5617 46.5554C34.8007 46.7991 35.1258 46.9394 35.4672 46.946H51.1099C51.4513 46.9394 51.7764 46.7991 52.0154 46.5553C52.2545 46.3116 52.3883 45.9838 52.3883 45.6424C52.3883 45.301 52.2545 44.9733 52.0154 44.7295C51.7764 44.4858 51.4513 44.3455 51.1099 44.3389Z" fill="#D997FF"/>
  <path d="M48.8134 50.3848H35.4671C35.1258 50.3914 34.8007 50.5317 34.5616 50.7755C34.3226 51.0192 34.1887 51.347 34.1887 51.6884C34.1887 52.0298 34.3226 52.3575 34.5617 52.6013C34.8007 52.845 35.1258 52.9853 35.4672 52.9919H48.8134C49.1548 52.9853 49.4799 52.845 49.7189 52.6013C49.9579 52.3575 50.0918 52.0297 50.0918 51.6883C50.0918 51.3469 49.9579 51.0192 49.7189 50.7754C49.4799 50.5317 49.1548 50.3914 48.8134 50.3848Z" fill="#D997FF"/>
</svg>
);

const VideoScriptIcon: React.FC<{ size?: number }> = ({ size = 35 }) => (
<svg width={size} height={size} viewBox="0 0 88 74" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M1.54275 3.19713H86.1251C86.5363 3.19075 86.9285 3.02291 87.2171 2.72985C87.5056 2.43679 87.6673 2.04201 87.6673 1.63075C87.6673 1.21948 87.5056 0.824714 87.217 0.53167C86.9285 0.238626 86.5362 0.0708115 86.125 0.0644531H1.54275C1.13153 0.0708239 0.739315 0.23865 0.450768 0.531702C0.16222 0.824755 0.000488281 1.21953 0.000488281 1.63079C0.000488281 2.04206 0.16222 2.43683 0.450768 2.72988C0.739315 3.02294 1.13153 3.19076 1.54275 3.19713Z" fill="#F5B7E9"/>
  <path d="M86.1251 69.9316H1.5427C1.13149 69.938 0.739274 70.1059 0.450735 70.3989C0.162196 70.692 0.000475944 71.0868 0.000488282 71.498C0.00050062 71.9093 0.162244 72.3041 0.4508 72.5971C0.739357 72.8901 1.13158 73.058 1.5428 73.0643H86.1251C86.5363 73.058 86.9285 72.8901 87.217 72.5971C87.5056 72.304 87.6673 71.9092 87.6673 71.498C87.6673 71.0867 87.5056 70.6919 87.217 70.3989C86.9285 70.1058 86.5363 69.938 86.1251 69.9316Z" fill="#F5B7E9"/>
  <path d="M1.54265 16.2016C1.13252 16.2096 0.741886 16.3782 0.454673 16.671C0.16746 16.9639 0.00657949 17.3578 0.0065918 17.768C0.0066041 18.1782 0.167508 18.572 0.454739 18.8649C0.741969 19.1578 1.13261 19.3263 1.54274 19.3343H10.7419C11.5724 19.3332 12.3685 19.0028 12.9558 18.4155C13.5431 17.8283 13.8735 17.0321 13.8745 16.2016V12.119C13.8735 11.2885 13.5431 10.4923 12.9558 9.90506C12.3685 9.31781 11.5724 8.98741 10.7419 8.98633H1.54265C1.13252 8.99434 0.741886 9.16289 0.454673 9.45577C0.16746 9.74865 0.00657949 10.1425 0.0065918 10.5527C0.0066041 10.9629 0.167508 11.3568 0.454739 11.6496C0.741969 11.9425 1.13261 12.111 1.54274 12.119H10.7419V16.2016H1.54265Z" fill="#F5B7E9"/>
  <path d="M32.3277 12.119C32.3266 11.2885 31.9962 10.4923 31.409 9.90506C30.8217 9.31781 30.0255 8.98741 29.195 8.98633H21.5637C20.7332 8.98741 19.937 9.31781 19.3498 9.90506C18.7625 10.4923 18.4321 11.2885 18.431 12.119V16.2016C18.4321 17.0321 18.7625 17.8283 19.3498 18.4155C19.937 19.0028 20.7332 19.3332 21.5637 19.3343H29.195C30.0255 19.3332 30.8217 19.0028 31.409 18.4155C31.9962 17.8283 32.3266 17.0321 32.3277 16.2016V12.119ZM29.195 16.2016H21.5637V12.119H29.195V16.2016Z" fill="#F5B7E9"/>
  <path d="M40.0171 19.3343H47.6499C48.4804 19.3332 49.2765 19.0028 49.8638 18.4155C50.4511 17.8283 50.7815 17.0321 50.7825 16.2016V12.119C50.7815 11.2885 50.4511 10.4923 49.8638 9.90506C49.2765 9.31781 48.4804 8.98741 47.6499 8.98633H40.0171C39.1866 8.98741 38.3904 9.31781 37.8031 9.90506C37.2159 10.4923 36.8855 11.2885 36.8844 12.119V16.2016C36.8855 17.0321 37.2159 17.8283 37.8031 18.4155C38.3904 19.0028 39.1866 19.3332 40.0171 19.3343ZM40.0171 12.119H47.6499V16.2016H40.0171V12.119Z" fill="#F5B7E9"/>
  <path d="M69.236 12.119C69.235 11.2885 68.9046 10.4923 68.3173 9.90506C67.73 9.31781 66.9339 8.98741 66.1034 8.98633H58.472C57.6415 8.98741 56.8454 9.31781 56.2581 9.90506C55.6708 10.4923 55.3404 11.2885 55.3394 12.119V16.2016C55.3404 17.0321 55.6708 17.8283 56.2581 18.4155C56.8453 19.0028 57.6415 19.3332 58.472 19.3343H66.1034C66.9339 19.3332 67.73 19.0028 68.3173 18.4155C68.9046 17.8283 69.235 17.0321 69.236 16.2016V12.119ZM66.1034 16.2016H58.472V12.119H66.1034V16.2016Z" fill="#F5B7E9"/>
  <path d="M86.1247 12.119C86.5349 12.111 86.9255 11.9424 87.2127 11.6496C87.4999 11.3567 87.6608 10.9628 87.6608 10.5526C87.6608 10.1424 87.4999 9.74857 87.2126 9.4557C86.9254 9.16284 86.5348 8.99431 86.1246 8.98633H76.9255C76.095 8.98741 75.2988 9.31781 74.7116 9.90506C74.1243 10.4923 73.7939 11.2885 73.7928 12.119V16.2016C73.7939 17.0321 74.1243 17.8283 74.7116 18.4155C75.2988 19.0028 76.095 19.3332 76.9255 19.3343H86.1247C86.5349 19.3263 86.9255 19.1577 87.2127 18.8648C87.4999 18.5719 87.6608 18.1781 87.6608 17.7679C87.6608 17.3577 87.4999 16.9638 87.2126 16.671C86.9254 16.3781 86.5348 16.2096 86.1246 16.2016H76.9256V12.119H86.1247Z" fill="#F5B7E9"/>
  <path d="M1.54265 61.0092C1.13252 61.0172 0.741886 61.1858 0.454673 61.4787C0.16746 61.7715 0.00657949 62.1654 0.0065918 62.5756C0.0066041 62.9858 0.167508 63.3797 0.454739 63.6725C0.741969 63.9654 1.13261 64.1339 1.54274 64.1419H10.7419C11.5724 64.1408 12.3685 63.8104 12.9558 63.2232C13.5431 62.6359 13.8735 61.8397 13.8745 61.0092V56.9266C13.8735 56.0961 13.5431 55.2999 12.9558 54.7127C12.3685 54.1254 11.5724 53.795 10.7419 53.7939H1.54265C1.13252 53.802 0.741886 53.9705 0.454673 54.2634C0.16746 54.5563 0.00657949 54.9501 0.0065918 55.3603C0.0066041 55.7705 0.167508 56.1644 0.454739 56.4573C0.741969 56.7501 1.13261 56.9186 1.54274 56.9266H10.7419V61.0092H1.54265Z" fill="#F5B7E9"/>
  <path d="M29.195 53.7939H21.5637C20.7332 53.795 19.937 54.1254 19.3498 54.7127C18.7625 55.2999 18.4321 56.0961 18.431 56.9266V61.0092C18.4321 61.8397 18.7625 62.6359 19.3498 63.2232C19.937 63.8104 20.7332 64.1408 21.5637 64.1419H29.195C30.0255 64.1408 30.8217 63.8104 31.409 63.2232C31.9962 62.6359 32.3266 61.8397 32.3277 61.0092V56.9266C32.3266 56.0961 31.9962 55.2999 31.409 54.7127C30.8217 54.1254 30.0255 53.795 29.195 53.7939ZM29.195 61.0092H21.5637V56.9266H29.195V61.0092Z" fill="#F5B7E9"/>
  <path d="M40.0171 53.7939C39.1866 53.795 38.3904 54.1254 37.8031 54.7127C37.2159 55.2999 36.8855 56.0961 36.8844 56.9266V61.0092C36.8855 61.8397 37.2159 62.6359 37.8031 63.2232C38.3904 63.8104 39.1866 64.1408 40.0171 64.1419H47.6499C48.4804 64.1408 49.2765 63.8104 49.8638 63.2232C50.4511 62.6359 50.7815 61.8397 50.7825 61.0092V56.9266C50.7815 56.0961 50.4511 55.2999 49.8638 54.7127C49.2765 54.1254 48.4804 53.795 47.6499 53.7939H40.0171ZM47.6499 61.0092H40.0171V56.9266H47.6499V61.0092Z" fill="#F5B7E9"/>
  <path d="M66.1034 53.7939H58.472C57.6415 53.795 56.8453 54.1254 56.2581 54.7127C55.6708 55.2999 55.3404 56.0961 55.3394 56.9266V61.0092C55.3404 61.8397 55.6708 62.6359 56.2581 63.2232C56.8454 63.8104 57.6415 64.1408 58.472 64.1419H66.1034C66.9339 64.1408 67.73 63.8104 68.3173 63.2232C68.9046 62.6359 69.235 61.8397 69.236 61.0092V56.9266C69.235 56.0961 68.9046 55.2999 68.3173 54.7127C67.73 54.1254 66.9339 53.795 66.1034 53.7939ZM66.1034 61.0092H58.472V56.9266H66.1034V61.0092Z" fill="#F5B7E9"/>
  <path d="M86.1246 56.9266C86.5348 56.9186 86.9254 56.7501 87.2126 56.4572C87.4998 56.1643 87.6607 55.7704 87.6607 55.3602C87.6607 54.95 87.4998 54.5562 87.2126 54.2633C86.9253 53.9705 86.5347 53.8019 86.1245 53.7939H76.9255C76.095 53.795 75.2988 54.1254 74.7116 54.7127C74.1243 55.2999 73.7939 56.0961 73.7928 56.9266V61.0092C73.7939 61.8397 74.1243 62.6359 74.7116 63.2232C75.2988 63.8104 76.095 64.1408 76.9255 64.1419H86.1246C86.5348 64.1339 86.9254 63.9653 87.2126 63.6725C87.4998 63.3796 87.6607 62.9857 87.6607 62.5755C87.6607 62.1653 87.4998 61.7715 87.2126 61.4786C86.9253 61.1857 86.5347 61.0172 86.1245 61.0092H76.9255V56.9266H86.1246Z" fill="#F5B7E9"/>
  <path d="M54.7076 36.5649C54.7081 35.8896 54.5433 35.2244 54.2276 34.6274C53.9119 34.0304 53.4549 33.5198 52.8965 33.14L39.4343 23.9745C38.8116 23.5504 38.085 23.3042 37.3328 23.2623C36.5806 23.2204 35.8312 23.3844 35.1652 23.7366C34.4993 24.0889 33.942 24.616 33.5533 25.2614C33.1646 25.9068 32.9593 26.6459 32.9594 27.3993V45.7304C32.9593 46.4838 33.1646 47.2229 33.5533 47.8683C33.942 48.5137 34.4993 49.0408 35.1652 49.3931C35.8312 49.7454 36.5806 49.9093 37.3328 49.8674C38.085 49.8255 38.8116 49.5793 39.4343 49.1552L52.8981 39.9897C53.456 39.6096 53.9126 39.0988 54.228 38.5019C54.5434 37.905 54.708 37.24 54.7076 36.5649ZM51.1344 37.4016L37.6721 46.5671C37.5201 46.6706 37.3427 46.7307 37.1591 46.7409C36.9754 46.7511 36.7925 46.711 36.6299 46.6249C36.4674 46.5389 36.3314 46.4101 36.2366 46.2524C36.1418 46.0948 36.0918 45.9143 36.092 45.7304V27.3993C36.0894 27.2148 36.1384 27.0332 36.2335 26.8751C36.3287 26.7169 36.4662 26.5886 36.6305 26.5045C36.7931 26.4189 36.9759 26.3791 37.1593 26.3893C37.3428 26.3996 37.52 26.4595 37.6721 26.5627L51.1328 35.7282C51.2689 35.8211 51.3803 35.9459 51.4574 36.0916C51.5344 36.2373 51.5747 36.3996 51.5749 36.5644C51.575 36.7293 51.535 36.8917 51.4582 37.0375C51.3815 37.1834 51.2703 37.3084 51.1344 37.4016Z" fill="#F5B7E9"/>
</svg>
);

const TextPresentationIcon: React.FC<{ size?: number }> = ({ size = 35 }) => (
<svg width={size} height={size} viewBox="0 0 52 74" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M47.8406 0.128906H13.3825C12.8649 0.130096 12.3526 0.233493 11.875 0.433165C11.3975 0.632836 10.9641 0.92485 10.5997 1.29245L1.12713 10.8878C0.402858 11.6184 -0.00227592 12.6063 0.000502478 13.635V69.2182C0.00163423 70.255 0.414018 71.2491 1.14717 71.9822C1.88033 72.7154 2.87438 73.1278 3.91122 73.1289H47.8406C48.8774 73.1278 49.8715 72.7154 50.6046 71.9822C51.3378 71.2491 51.7502 70.255 51.7513 69.2182V4.03962C51.7502 3.00278 51.3378 2.00873 50.6046 1.27558C49.8715 0.542422 48.8774 0.130038 47.8406 0.128906ZM12.0789 3.50607V11.1335C12.0786 11.4791 11.9411 11.8105 11.6967 12.0549C11.4523 12.2993 11.121 12.4367 10.7753 12.4371H3.26225L12.0789 3.50607ZM49.1442 69.2182C49.1438 69.5638 49.0064 69.8952 48.762 70.1396C48.5176 70.384 48.1862 70.5214 47.8406 70.5218H3.91124C3.56562 70.5214 3.23425 70.384 2.98986 70.1396C2.74547 69.8952 2.60802 69.5638 2.60767 69.2182V15.0442H10.7753C11.8122 15.0431 12.8062 14.6307 13.5394 13.8976C14.2725 13.1644 14.6849 12.1704 14.6861 11.1335V2.73605H47.8406C48.1862 2.73639 48.5176 2.87385 48.762 3.11824C49.0064 3.36263 49.1438 3.694 49.1442 4.03962V69.2182Z" fill="#F9CFF1"/>
  <path d="M10.2332 40.4685H21.9196C22.2609 40.4618 22.586 40.3215 22.825 40.0778C23.064 39.834 23.1979 39.5063 23.1979 39.1649C23.1979 38.8235 23.064 38.4957 22.825 38.252C22.5859 38.0082 22.2608 37.868 21.9195 37.8613H10.2332C9.89191 37.868 9.56681 38.0082 9.32777 38.252C9.08874 38.4957 8.95483 38.8235 8.95483 39.1649C8.95483 39.5063 9.08874 39.8341 9.32777 40.0778C9.56681 40.3216 9.89191 40.4618 10.2332 40.4685Z" fill="#F9CFF1"/>
  <path d="M17.846 19.8903H33.0726C33.4139 19.8837 33.739 19.7434 33.9781 19.4997C34.2171 19.2559 34.351 18.9281 34.351 18.5867C34.351 18.2453 34.2171 17.9176 33.978 17.6738C33.739 17.4301 33.4139 17.2898 33.0725 17.2832H17.846C17.5047 17.2899 17.1796 17.4301 16.9406 17.6739C16.7015 17.9176 16.5676 18.2454 16.5676 18.5868C16.5676 18.9282 16.7015 19.2559 16.9406 19.4997C17.1796 19.7434 17.5047 19.8837 17.846 19.8903Z" fill="#F9CFF1"/>
  <path d="M41.5189 27.5723H10.2332C9.89187 27.5789 9.56677 27.7192 9.32774 27.963C9.08871 28.2067 8.95482 28.5345 8.95483 28.8759C8.95485 29.2173 9.08876 29.545 9.32781 29.7888C9.56685 30.0325 9.89196 30.1728 10.2333 30.1794H41.5189C41.8601 30.1726 42.1851 30.0322 42.424 29.7885C42.6629 29.5448 42.7967 29.2171 42.7967 28.8758C42.7967 28.5346 42.6629 28.2069 42.424 27.9632C42.1851 27.7194 41.8601 27.5791 41.5189 27.5723Z" fill="#F9CFF1"/>
  <path d="M41.5177 37.8613H26.3955C26.0542 37.868 25.7291 38.0083 25.4901 38.252C25.2511 38.4958 25.1172 38.8236 25.1172 39.1649C25.1172 39.5063 25.2511 39.8341 25.4902 40.0778C25.7292 40.3216 26.0543 40.4618 26.3956 40.4685H41.5177C41.8591 40.4618 42.1842 40.3216 42.4232 40.0778C42.6623 39.8341 42.7962 39.5063 42.7962 39.1649C42.7962 38.8235 42.6623 38.4957 42.4232 38.252C42.1842 38.0082 41.8591 37.868 41.5177 37.8613Z" fill="#F9CFF1"/>
  <path d="M41.5189 48.1504H10.2332C9.89187 48.1571 9.56677 48.2973 9.32774 48.5411C9.08871 48.7848 8.95482 49.1126 8.95483 49.454C8.95485 49.7954 9.08876 50.1232 9.32781 50.3669C9.56685 50.6106 9.89196 50.7509 10.2333 50.7575H41.5189C41.8601 50.7507 42.1851 50.6104 42.424 50.3666C42.6629 50.1229 42.7967 49.7952 42.7967 49.454C42.7967 49.1127 42.6629 48.785 42.424 48.5413C42.1851 48.2976 41.8601 48.1572 41.5189 48.1504Z" fill="#F9CFF1"/>
  <path d="M41.5189 57.8467H10.2332C9.89187 57.8533 9.56677 57.9936 9.32774 58.2374C9.08871 58.4811 8.95482 58.8089 8.95483 59.1503C8.95485 59.4917 9.08876 59.8195 9.32781 60.0632C9.56685 60.3069 9.89196 60.4472 10.2333 60.4538H41.5189C41.8601 60.447 42.1851 60.3067 42.424 60.0629C42.6629 59.8192 42.7967 59.4915 42.7967 59.1503C42.7967 58.809 42.6629 58.4813 42.424 58.2376C42.1851 57.9938 41.8601 57.8535 41.5189 57.8467Z" fill="#F9CFF1"/>
</svg>
);



function GenerateProductPicker() {
  const { t } = useLanguage();
  const router = useRouter();
  const searchParams = useSearchParams();
  const isFromFiles = searchParams?.get('fromFiles') === 'true';
  const isFromKnowledgeBase = searchParams?.get('fromKnowledgeBase') === 'true';
  const folderIds = searchParams?.get('folderIds')?.split(',').filter(Boolean) || [];
  const fileIds = searchParams?.get('fileIds')?.split(',').filter(Boolean) || [];
  const isFromText = searchParams?.get('fromText') === 'true';
  const textMode = searchParams?.get('textMode') as 'context' | 'base' | null;
  
  // NEW: Connector context from URL parameters and sessionStorage
  const isFromConnectors = searchParams?.get('fromConnectors') === 'true';
  const connectorIds = searchParams?.get('connectorIds')?.split(',').filter(Boolean) || [];
  const connectorSources = searchParams?.get('connectorSources')?.split(',').filter(Boolean) || [];
  const [connectorContext, setConnectorContext] = useState<{
    fromConnectors: boolean;
    connectorIds: string[];
    connectorSources: string[];
  } | null>(null);

  // Load connector context from sessionStorage
  useEffect(() => {
    if (isFromConnectors) {
      try {
        const storedConnectorContext = sessionStorage.getItem('connectorContext');
        if (storedConnectorContext) {
          const context = JSON.parse(storedConnectorContext);
          // Check if data is recent (within 1 hour)
          if (context.timestamp && (Date.now() - context.timestamp < 3600000)) {
            setConnectorContext(context);
          } else {
            sessionStorage.removeItem('connectorContext');
          }
        } else {
          // Use URL parameters if sessionStorage is not available
          setConnectorContext({
            fromConnectors: true,
            connectorIds,
            connectorSources
          });
        }
      } catch (error) {
        console.error('Error retrieving connector context:', error);
        // Fallback to URL parameters
        setConnectorContext({
          fromConnectors: true,
          connectorIds,
          connectorSources
        });
      }
    }
  }, [isFromConnectors, connectorIds.join(','), connectorSources.join(',')]);
  
  // Check for folder context from sessionStorage (when coming from inside a folder)
  const [folderContext, setFolderContext] = useState<{ folderId: string } | null>(null);
  useEffect(() => {
    try {
      const storedFolderContext = sessionStorage.getItem('folderContext');
      if (storedFolderContext) {
        const context = JSON.parse(storedFolderContext);
        // Check if data is recent (within 1 hour)
        if (context.timestamp && (Date.now() - context.timestamp < 3600000)) {
          setFolderContext(context);
        } else {
          sessionStorage.removeItem('folderContext');
        }
      }
    } catch (error) {
      console.error('Error retrieving folder context:', error);
    }
  }, []);
  
  // Retrieve user text from sessionStorage
  const [userText, setUserText] = useState('');
  useEffect(() => {
    if (isFromText) {
      try {
        const storedData = sessionStorage.getItem('pastedTextData');
        if (storedData) {
          const textData = JSON.parse(storedData);
          // Check if data is recent (within 1 hour) and matches the current mode
          if (textData.timestamp && (Date.now() - textData.timestamp < 3600000) && textData.mode === textMode) {
            setUserText(textData.text || '');
          }
        }
      } catch (error) {
        console.error('Error retrieving pasted text data:', error);
      }
    }
  }, [isFromText, textMode]);
  
  // For prompt input and filters we keep in state and navigate later
  const [prompt, setPrompt] = useState("");
  const [modulesCount, setModulesCount] = useState(4);
  const [lessonsPerModule, setLessonsPerModule] = useState(`3-4 ${t('interface.generate.perModule', 'per module')}`);
  const [language, setLanguage] = useState(t('interface.english', 'English'));

  // All filters are always true (removed dropdown functionality)
  const filters = {
    knowledgeCheck: true,
    contentAvailability: true,
    informationSource: true,
    time: true,
  };

  const allExamples = [
    "Code Optimization Course",
    "Junior AI/ML Engineer Training",
    "New Employee Onboarding",
    "Step to analyze the market",
    "How to choose the right pricing strategy",
    "Course on AI tools for teachers of the high school",
    "Course 'How to start learning Spanish'",
    "Customer journey mapping",
    "A guide to investing in real estate",
  ];

  const stylePurposes = {
    headlines: t('interface.generate.headlinesPurpose', 'Section titles and headings'),
    paragraphs: t('interface.generate.paragraphsPurpose', 'Regular text blocks'),
    bullet_lists: t('interface.generate.bulletListsPurpose', 'Unordered lists with bullet points'),
    numbered_lists: t('interface.generate.numberedListsPurpose', 'Ordered lists with numbers'),
    alerts: t('interface.generate.alertsPurpose', 'Important warnings or tips'),
    recommendations: t('interface.generate.recommendationsPurpose', 'Actionable advice'),
    section_breaks: t('interface.generate.sectionBreaksPurpose', 'Visual separators between sections'),
    icons: t('interface.generate.iconsPurpose', 'Emojis and visual elements'),
    important_sections: t('interface.generate.importantSectionsPurpose', 'Highlighted critical content')
  };

  const getRandomExamples = () => {
    const shuffled = [...allExamples].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 6);
  };
  const [examples, setExamples] = useState<string[]>(getRandomExamples());

  const shuffleExamples = () => setExamples(getRandomExamples());

  const CUSTOM_BACKEND_URL =
    process.env.NEXT_PUBLIC_CUSTOM_BACKEND_URL || "/api/custom-projects-backend";

  const handleCourseOutlineStart = async () => {
    if (!prompt.trim() && !isFromFiles && !isFromText && !isFromKnowledgeBase) return;

    let chatId: string | undefined;
    try {
      const res = await fetch(`${CUSTOM_BACKEND_URL}/course-outline/init-chat`, {
        method: "POST",
      });
      if (res.ok) {
        const data = await res.json();
        chatId = data.chatSessionId;
      }
    } catch (_) {
      /* ignore warm-up failure â€“ preview will fallback to creating chat */
    }

    let finalPrompt = prompt.trim();
    if (isFromFiles && !finalPrompt) {
      finalPrompt = "Create educational content from the provided files";
    } else if (isFromText && !finalPrompt) {
      finalPrompt = textMode === 'context' 
        ? "Create educational content using the provided text as context"
        : "Create educational content based on the provided text structure";
    } else if (isFromKnowledgeBase && !finalPrompt) {
      finalPrompt = "Create educational content by searching the Knowledge Base";
    }

          // Store prompt in sessionStorage if it's long (over 500 characters)
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }

    const params = new URLSearchParams({
      prompt: promptReference,
      modules: String(modulesCount),
      lessons: lessonsPerModule,
      lang: language,
      knowledgeCheck: filters.knowledgeCheck ? '1' : '0',
      contentAvailability: filters.contentAvailability ? '1' : '0',
      informationSource: filters.informationSource ? '1' : '0',
      time: filters.time ? '1' : '0',
    });
    if (chatId) params.set("chatId", chatId);
    
    // Add file context if coming from files
    if (isFromFiles) {
      params.set("fromFiles", "true");
      if (folderIds.length > 0) params.set("folderIds", folderIds.join(','));
      if (fileIds.length > 0) params.set("fileIds", fileIds.join(','));
    }
    
    // Add Knowledge Base context if coming from Knowledge Base
    if (isFromKnowledgeBase) {
      params.set("fromKnowledgeBase", "true");
    }
    
    // Add text context if coming from text
    if (isFromText) {
      params.set("fromText", "true");
      params.set("textMode", textMode || 'context');
      // userText stays in sessionStorage - don't pass via URL
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    router.push(`/create/course-outline?${params.toString()}`);
  };

  // Ref for auto-resizing the prompt textarea
  const promptRef = useRef<HTMLTextAreaElement>(null);

  // Adjust the textarea height as the prompt changes
  useEffect(() => {
    if (promptRef.current) {
      // Reset height to shrink when deleting text
      promptRef.current.style.height = "auto";
      // Set height based on scroll height
      promptRef.current.style.height = `${promptRef.current.scrollHeight}px`;
    }
  }, [prompt]);

  const [activeProduct, setActiveProduct] = useState<"Course" | "Video Lesson" | "Presentation" | "Quiz" | "One-Pager">("Course");

  // Handle URL parameters and sessionStorage for pre-selecting product
  useEffect(() => {
    const product = searchParams?.get('product');
    const lessonType = searchParams?.get('lessonType');
    const lessonTitle = searchParams?.get('lessonTitle');
    const moduleName = searchParams?.get('moduleName');
    const lessonNumber = searchParams?.get('lessonNumber');

    // Check both URL parameters and sessionStorage for lesson/quiz context
    let lessonContext = null;
    
    if (product === 'lesson' && lessonType && lessonTitle && moduleName && lessonNumber) {
      lessonContext = { product, lessonType, lessonTitle, moduleName, lessonNumber };
    } else if (product === 'quiz' && lessonType && lessonTitle && moduleName && lessonNumber) {
      lessonContext = { product, lessonType, lessonTitle, moduleName, lessonNumber };
    } else if (product === 'text-presentation' && lessonType && lessonTitle && moduleName && lessonNumber) {
      lessonContext = { product, lessonType, lessonTitle, moduleName, lessonNumber };
    } else {
      // Try to get from sessionStorage
      try {
        const lessonContextData = sessionStorage.getItem('lessonContext');
        if (lessonContextData) {
          const storedContext = JSON.parse(lessonContextData);
          // Check if data is recent (within 1 hour)
          if (storedContext.timestamp && (Date.now() - storedContext.timestamp < 3600000)) {
            lessonContext = storedContext;
          }
        }
      } catch (error) {
        console.error('Error retrieving lesson context:', error);
      }
    }

    if (lessonContext) {
      if (lessonContext.product === 'quiz') {
        setActiveProduct("Quiz");
        
        // Since we have quiz context from the modal, automatically set useExistingQuizOutline to true
        // This bypasses the "Do you want to create a quiz from an existing Course Outline?" question
        setUseExistingQuizOutline(true);
        
        // Store quiz context for pre-selecting dropdowns after outlines are loaded
        sessionStorage.setItem('lessonContextForDropdowns', JSON.stringify(lessonContext));
      } else if (lessonContext.product === 'text-presentation') {
        setActiveProduct("One-Pager");
        setUseExistingTextOutline(true);
        sessionStorage.setItem('lessonContextForDropdowns', JSON.stringify(lessonContext));
      } else {
        setActiveProduct("Presentation");
        
        // Since we have lesson context from the modal, automatically set useExistingOutline to true
        // This bypasses the "Do you want to create a lesson from an existing Course Outline?" question
        setUseExistingOutline(true);
        
        // Store lesson context for pre-selecting dropdowns after outlines are loaded
        sessionStorage.setItem('lessonContextForDropdowns', JSON.stringify(lessonContext));
      }
    }
  }, [searchParams]);

  // Clear context when switching between products, but not during initial setup
  useEffect(() => {
    // Add a small delay to ensure the first useEffect runs first
    const timer = setTimeout(() => {
      // Skip if we're in the middle of setting up context from modal
      try {
        const lessonContextData = sessionStorage.getItem('lessonContext');
        if (lessonContextData) {
          const storedContext = JSON.parse(lessonContextData);
          // If we have recent context, don't clear it
          if (storedContext.timestamp && (Date.now() - storedContext.timestamp < 3600000)) {
            return;
          }
        }
      } catch (error) {
        // Continue with clearing if there's an error
      }

          // Clear lesson context when switching away from Presentation
    if (activeProduct !== "Presentation") {
        setUseExistingOutline(false);  // Default to standalone mode instead of null
        setSelectedOutlineId(null);
        setSelectedModuleIndex(null);
        setLessonsForModule([]);
        setSelectedLesson("");
      }
      
      // Clear quiz context when switching away from Quiz
      if (activeProduct !== "Quiz") {
        setUseExistingQuizOutline(false);  // Default to standalone mode instead of null
        setSelectedQuizOutlineId(null);
        setSelectedQuizModuleIndex(null);
        setQuizLessonsForModule([]);
        setSelectedQuizLesson("");
      }
      
      // Clear text presentation context when switching away from One-Pager
      if (activeProduct !== "One-Pager") {
        setUseExistingTextOutline(false);  // Default to standalone mode instead of null
        setSelectedTextOutlineId(null);
        setSelectedTextModuleIndex(null);
        setTextLessonsForModule([]);
        setSelectedTextLesson("");
      }
      
      // Clear video lesson context when switching away from Video Lesson
      if (activeProduct !== "Video Lesson") {
        // Video Lesson uses the same state as Presentation, so no additional cleanup needed
      }
    }, 100); // 100ms delay

    return () => clearTimeout(timer);
  }, [activeProduct]);

  // --- Lesson Presentation specific state ---
  const [outlines, setOutlines] = useState<{ id: number; name: string }[]>([]);
  const [selectedOutlineId, setSelectedOutlineId] = useState<number | null>(null);
  const [modulesForOutline, setModulesForOutline] = useState<{ name: string; lessons: string[] }[]>([]);
  const [selectedModuleIndex, setSelectedModuleIndex] = useState<number | null>(null);
  const [lessonsForModule, setLessonsForModule] = useState<string[]>([]);
  const [selectedLesson, setSelectedLesson] = useState<string>("");
  const [lengthOption, setLengthOption] = useState<"Short" | "Medium" | "Long">("Short");
  const [slidesCount, setSlidesCount] = useState<number>(5);
  const [useExistingOutline, setUseExistingOutline] = useState<boolean | null>(false);

  // --- Quiz specific state ---
  const [quizOutlines, setQuizOutlines] = useState<{ id: number; name: string }[]>([]);
  const [selectedQuizOutlineId, setSelectedQuizOutlineId] = useState<number | null>(null);
  const [quizModulesForOutline, setQuizModulesForOutline] = useState<{ name: string; lessons: string[] }[]>([]);
  const [selectedQuizModuleIndex, setSelectedQuizModuleIndex] = useState<number | null>(null);
  const [quizLessonsForModule, setQuizLessonsForModule] = useState<string[]>([]);
  const [selectedQuizLesson, setSelectedQuizLesson] = useState<string>("");
  const [quizQuestionCount, setQuizQuestionCount] = useState(10);
  const [quizLanguage, setQuizLanguage] = useState(t('interface.english', 'English'));
  const [useExistingQuizOutline, setUseExistingQuizOutline] = useState<boolean | null>(false);
  const [selectedQuestionTypes, setSelectedQuestionTypes] = useState<string[]>([
    "multiple-choice",
    "multi-select", 
    "matching",
    "sorting",
    "open-answer"
  ]);
  const [showQuestionTypesDropdown, setShowQuestionTypesDropdown] = useState(false);

  // Click outside handler for question types dropdown
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (showQuestionTypesDropdown) {
        const target = event.target as Element;
        if (!target.closest('.question-types-dropdown')) {
          setShowQuestionTypesDropdown(false);
        }
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showQuestionTypesDropdown]);

  // Fetch outlines when switching to Presentation tab and user chooses to use existing outline
  useEffect(() => {
    if (activeProduct !== "Presentation" || useExistingOutline !== true) return;
    const fetchOutlines = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects`);
        if (!res.ok) return;
        const data = await res.json();
        const onlyOutlines = data.filter((p: any) => (p?.design_microproduct_type || p?.product_type) === "Training Plan");
        setOutlines(onlyOutlines.map((p: any) => ({ id: p.id, name: p.projectName })));
        
        // Check if we have lesson context to pre-select outline
        try {
          const lessonContextData = sessionStorage.getItem('lessonContextForDropdowns');
          if (lessonContextData) {
            const lessonContext = JSON.parse(lessonContextData);
            // Find the outline that contains the specific module and lesson
            // We'll need to fetch each outline to check its modules and lessons
            for (const outline of onlyOutlines) {
              const outlineRes = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${outline.id}`);
              if (outlineRes.ok) {
                const outlineData = await outlineRes.json();
                const sections = outlineData?.details?.sections || [];
                const modules = sections.map((sec: any) => ({
                  name: sec.title || "Unnamed module",
                  lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
                }));
                
                // Check if this outline contains the target module and lesson
                const targetModuleIndex = modules.findIndex((m: any) => 
                  m.name.toLowerCase().includes(lessonContext.moduleName.toLowerCase()) ||
                  lessonContext.moduleName.toLowerCase().includes(m.name.toLowerCase())
                );
                
                if (targetModuleIndex !== -1) {
                  const targetModule = modules[targetModuleIndex];
                  const targetLessonIndex = targetModule.lessons.findIndex((l: string) => 
                    l.toLowerCase().includes(lessonContext.lessonTitle.toLowerCase()) ||
                    lessonContext.lessonTitle.toLowerCase().includes(l.toLowerCase())
                  );
                  
                  if (targetLessonIndex !== -1) {
                    // Found the matching outline, module, and lesson
                    setSelectedOutlineId(outline.id);
                    setModulesForOutline(modules);
                    setSelectedModuleIndex(targetModuleIndex);
                    setLessonsForModule(targetModule.lessons);
                    setSelectedLesson(targetModule.lessons[targetLessonIndex]);
                    
                    // Clear the stored context
                    sessionStorage.removeItem('lessonContextForDropdowns');
                    break;
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error pre-selecting outline:', error);
        }
      } catch (_) {}
    };
    fetchOutlines();
  }, [activeProduct, useExistingOutline]);

  // Fetch lessons when outline changes
  useEffect(() => {
    if (activeProduct !== "Presentation" || selectedOutlineId == null || useExistingOutline !== true) return;
    
    // Skip if we already have modules loaded (from pre-selection)
    if (modulesForOutline.length > 0) return;
    
    const fetchLessons = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${selectedOutlineId}`);
        if (!res.ok) return;
        const data = await res.json();
        const sections = data?.details?.sections || [];
        const modules = sections.map((sec: any) => ({
          name: sec.title || "Unnamed module",
          lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
        }));
        setModulesForOutline(modules);
        // reset downstream selections
        setSelectedModuleIndex(null);
        setLessonsForModule([]);
        setSelectedLesson("");
      } catch (_) {}
    };
    fetchLessons();
  }, [selectedOutlineId, activeProduct, useExistingOutline, modulesForOutline.length]);

  // Fetch outlines when switching to Quiz tab and user chooses to use existing outline
  useEffect(() => {
    if (activeProduct !== "Quiz" || useExistingQuizOutline !== true) return;
    const fetchQuizOutlines = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects`);
        if (!res.ok) return;
        const data = await res.json();
        const onlyOutlines = data.filter((p: any) => (p?.design_microproduct_type || p?.product_type) === "Training Plan");
        setQuizOutlines(onlyOutlines.map((p: any) => ({ id: p.id, name: p.projectName })));
        
        // Check if we have quiz context to pre-select outline
        try {
          const lessonContextData = sessionStorage.getItem('lessonContextForDropdowns');
          if (lessonContextData) {
            const lessonContext = JSON.parse(lessonContextData);
            // Find the outline that contains the specific module and lesson
            // We'll need to fetch each outline to check its modules and lessons
            for (const outline of onlyOutlines) {
              const outlineRes = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${outline.id}`);
              if (outlineRes.ok) {
                const outlineData = await outlineRes.json();
                const sections = outlineData?.details?.sections || [];
                const modules = sections.map((sec: any) => ({
                  name: sec.title || "Unnamed module",
                  lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
                }));
                
                // Check if this outline contains the target module and lesson
                const targetModuleIndex = modules.findIndex((m: any) => 
                  m.name.toLowerCase().includes(lessonContext.moduleName.toLowerCase()) ||
                  lessonContext.moduleName.toLowerCase().includes(m.name.toLowerCase())
                );
                
                if (targetModuleIndex !== -1) {
                  const targetModule = modules[targetModuleIndex];
                  const targetLessonIndex = targetModule.lessons.findIndex((l: string) => 
                    l.toLowerCase().includes(lessonContext.lessonTitle.toLowerCase()) ||
                    lessonContext.lessonTitle.toLowerCase().includes(l.toLowerCase())
                  );
                  
                  if (targetLessonIndex !== -1) {
                    // Found the matching outline, module, and lesson
                    setSelectedQuizOutlineId(outline.id);
                    setQuizModulesForOutline(modules);
                    setSelectedQuizModuleIndex(targetModuleIndex);
                    setQuizLessonsForModule(targetModule.lessons);
                    setSelectedQuizLesson(targetModule.lessons[targetLessonIndex]);
                    
                    // Clear the stored context
                    sessionStorage.removeItem('lessonContextForDropdowns');
                    break;
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error pre-selecting quiz outline:', error);
        }
      } catch (_) {}
    };
    fetchQuizOutlines();
  }, [activeProduct, useExistingQuizOutline]);

  // Fetch lessons when quiz outline changes
  useEffect(() => {
    if (activeProduct !== "Quiz" || selectedQuizOutlineId == null || useExistingQuizOutline !== true) return;
    
    // Skip if we already have modules loaded (from pre-selection)
    if (quizModulesForOutline.length > 0) return;
    
    const fetchQuizLessons = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${selectedQuizOutlineId}`);
        if (!res.ok) return;
        const data = await res.json();
        const sections = data?.details?.sections || [];
        const modules = sections.map((sec: any) => ({
          name: sec.title || "Unnamed module",
          lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
        }));
        setQuizModulesForOutline(modules);
        // reset downstream selections
        setSelectedQuizModuleIndex(null);
        setQuizLessonsForModule([]);
        setSelectedQuizLesson("");
      } catch (_) {}
    };
    fetchQuizLessons();
  }, [selectedQuizOutlineId, activeProduct, useExistingQuizOutline, quizModulesForOutline.length]);

  // Helper to map length option to words
  const lengthRangeForOption = (opt: string) => {
    switch (opt) {
      case "Short":
        return "300-400 words";
      case "Medium":
        return "600-800 words";
      case "Long":
        return "1000-1500 words";
      default:
        return "300-400 words";
    }
  };

  // Helper to get translated length option
  const getTranslatedLengthOption = (opt: "Short" | "Medium" | "Long") => {
    switch (opt) {
      case "Short":
        return t('interface.generate.short', 'Short');
      case "Medium":
        return t('interface.generate.medium', 'Medium');
      case "Long":
        return t('interface.generate.long', 'Long');
      default:
        return t('interface.generate.short', 'Short');
    }
  };

  const handleSlideDeckStart = () => {
    // If using existing outline, check if outline and lesson selected
    if (useExistingOutline === true) {
      if (!selectedOutlineId || !selectedLesson) return;
    } else {
      // If standalone lesson, check if prompt entered or coming from files/text/knowledge base
      if (!prompt.trim() && !isFromFiles && !isFromText && !isFromKnowledgeBase) return;
    }

    const params = new URLSearchParams();
    if (useExistingOutline === true && selectedOutlineId) {
      params.set("outlineId", String(selectedOutlineId));
    }
    if (useExistingOutline === true && selectedLesson) {
      params.set("lesson", selectedLesson);
    }
    params.set("length", lengthRangeForOption(lengthOption));
    params.set("slidesCount", String(slidesCount));
    
    // Handle different prompt sources
    if (isFromFiles) {
      const finalPrompt = prompt.trim() || "Create lesson content from the provided files";
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromFiles", "true");
      if (folderIds.length > 0) params.set("folderIds", folderIds.join(','));
      if (fileIds.length > 0) params.set("fileIds", fileIds.join(','));
    } else if (isFromText) {
      const finalPrompt = prompt.trim() || (textMode === 'context' 
        ? "Create lesson content using the provided text as context"
        : "Create lesson content based on the provided text structure");
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromText", "true");
      params.set("textMode", textMode || 'context');
      // userText stays in sessionStorage - don't pass via URL
    } else if (isFromKnowledgeBase) {
      params.set("prompt", prompt.trim() || "Create lesson content from the Knowledge Base");
      params.set("fromKnowledgeBase", "true");
    } else if (prompt.trim()) {
      const finalPrompt = prompt.trim();
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
    }
    
    params.set("lang", language);

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    router.push(`/create/lesson-presentation?${params.toString()}`);
  };

  const handleQuizStart = () => {
    // If using existing outline, check if outline and lesson selected
    if (useExistingQuizOutline === true) {
      if (!selectedQuizOutlineId || !selectedQuizLesson) return;
    } else {
      // If standalone quiz, check if prompt entered or coming from files/text/knowledge base
      if (!prompt.trim() && !isFromFiles && !isFromText && !isFromKnowledgeBase) return;
    }

    const params = new URLSearchParams();
    if (useExistingQuizOutline === true && selectedQuizOutlineId) {
      params.set("outlineId", String(selectedQuizOutlineId));
    }
    if (useExistingQuizOutline === true && selectedQuizLesson) {
      params.set("lesson", selectedQuizLesson);
      // Add course name (outline name) for proper course context
      if (selectedQuizOutlineId && quizOutlines.find(o => o.id === selectedQuizOutlineId)) {
        const outline = quizOutlines.find(o => o.id === selectedQuizOutlineId);
        if (outline) {
          params.set("courseName", outline.name);
        }
      }
    }
    params.set("questionTypes", selectedQuestionTypes.join(','));
    params.set("questionCount", String(quizQuestionCount));
    params.set("lang", quizLanguage);
    
    // Handle different prompt sources
    if (isFromFiles) {
      const finalPrompt = prompt.trim() || "Create quiz content from the provided files";
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromFiles", "true");
      if (folderIds.length > 0) params.set("folderIds", folderIds.join(','));
      if (fileIds.length > 0) params.set("fileIds", fileIds.join(','));
    } else if (isFromText) {
      const finalPrompt = prompt.trim() || (textMode === 'context' 
        ? "Create quiz content using the provided text as context"
        : "Create quiz content based on the provided text structure");
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromText", "true");
      params.set("textMode", textMode || 'context');
      // userText stays in sessionStorage - don't pass via URL
    } else if (isFromKnowledgeBase) {
      params.set("prompt", prompt.trim() || "Create quiz content from the Knowledge Base");
      params.set("fromKnowledgeBase", "true");
    } else if (prompt.trim()) {
      const finalPrompt = prompt.trim();
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    router.push(`/create/quiz?${params.toString()}`);
  };

  // Text Presentation state (mimicking quiz pattern)
  const [useExistingTextOutline, setUseExistingTextOutline] = useState<boolean | null>(false);
  const [textOutlines, setTextOutlines] = useState<{ id: number; name: string }[]>([]);
  const [textModulesForOutline, setTextModulesForOutline] = useState<{ name: string; lessons: string[] }[]>([]);
  const [selectedTextModuleIndex, setSelectedTextModuleIndex] = useState<number | null>(null);
  const [textLessonsForModule, setTextLessonsForModule] = useState<string[]>([]);
  const [selectedTextOutlineId, setSelectedTextOutlineId] = useState<number | null>(null);
  const [selectedTextLesson, setSelectedTextLesson] = useState<string>("");
  const [textLanguage, setTextLanguage] = useState<string>(t('interface.english', 'English'));
  const [textLength, setTextLength] = useState<string>(t('interface.generate.medium', 'Medium'));
  const [textStyles, setTextStyles] = useState<string[]>(["headlines", "paragraphs", "bullet_lists", "numbered_lists", "alerts", "recommendations", "section_breaks", "icons", "important_sections"]);
  const [showTextStylesDropdown, setShowTextStylesDropdown] = useState(false);

  // Fetch one-pager outlines when product is selected
  useEffect(() => {
    if (activeProduct !== "One-Pager" || useExistingTextOutline !== true) return;
    
    const fetchTextOutlines = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects`);
        if (!res.ok) return;
        const data = await res.json();
        const onlyOutlines = data.filter((p: any) => (p?.design_microproduct_type || p?.product_type) === "Training Plan");
        setTextOutlines(onlyOutlines.map((p: any) => ({ id: p.id, name: p.projectName })));
        
        // Check if we have text context to pre-select outline
        try {
          const lessonContextData = sessionStorage.getItem('lessonContextForDropdowns');
          if (lessonContextData) {
            const lessonContext = JSON.parse(lessonContextData);
            // Find the outline that contains the specific module and lesson
            // We'll need to fetch each outline to check its modules and lessons
            for (const outline of onlyOutlines) {
              const outlineRes = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${outline.id}`);
              if (outlineRes.ok) {
                const outlineData = await outlineRes.json();
                const sections = outlineData?.details?.sections || [];
                const modules = sections.map((sec: any) => ({
                  name: sec.title || "Unnamed module",
                  lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
                }));
                
                // Check if this outline contains the target module and lesson
                const targetModuleIndex = modules.findIndex((m: any) => 
                  m.name.toLowerCase().includes(lessonContext.moduleName.toLowerCase()) ||
                  lessonContext.moduleName.toLowerCase().includes(m.name.toLowerCase())
                );
                
                if (targetModuleIndex !== -1) {
                  const targetModule = modules[targetModuleIndex];
                  const targetLessonIndex = targetModule.lessons.findIndex((l: string) => 
                    l.toLowerCase().includes(lessonContext.lessonTitle.toLowerCase()) ||
                    lessonContext.lessonTitle.toLowerCase().includes(l.toLowerCase())
                  );
                  
                  if (targetLessonIndex !== -1) {
                    // Found the matching outline, module, and lesson
                    setSelectedTextOutlineId(outline.id);
                    setTextModulesForOutline(modules);
                    setSelectedTextModuleIndex(targetModuleIndex);
                    setTextLessonsForModule(targetModule.lessons);
                    setSelectedTextLesson(targetModule.lessons[targetLessonIndex]);
                    
                    // Clear the stored context
                    sessionStorage.removeItem('lessonContextForDropdowns');
                    break;
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('Error pre-selecting text outline:', error);
        }
      } catch (_) {}
    };
    fetchTextOutlines();
  }, [activeProduct, useExistingTextOutline]);

  // Fetch lessons when text outline changes
  useEffect(() => {
    if (activeProduct !== "One-Pager" || selectedTextOutlineId == null || useExistingTextOutline !== true) return;
    
    // Skip if we already have modules loaded (from pre-selection)
    if (textModulesForOutline.length > 0) return;
    
    const fetchTextLessons = async () => {
      try {
        const res = await fetch(`${CUSTOM_BACKEND_URL}/projects/view/${selectedTextOutlineId}`);
        if (!res.ok) return;
        const data = await res.json();
        const sections = data?.details?.sections || [];
        const modules = sections.map((sec: any) => ({
          name: sec.title || "Unnamed module",
          lessons: (sec.lessons || []).map((ls: any) => ls.title || ""),
        }));
        setTextModulesForOutline(modules);
        // reset downstream selections
        setSelectedTextModuleIndex(null);
        setTextLessonsForModule([]);
        setSelectedTextLesson("");
      } catch (_) {}
    };
    fetchTextLessons();
  }, [selectedTextOutlineId, activeProduct, useExistingTextOutline, textModulesForOutline.length]);

  // Click outside handler for text styles dropdown
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (!target.closest('.text-styles-dropdown')) {
        setShowTextStylesDropdown(false);
      }
    };

    if (showTextStylesDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showTextStylesDropdown]);

  const handleTextPresentationStart = () => {
    // If using existing outline, check if outline and lesson selected
    if (useExistingTextOutline === true) {
      if (!selectedTextOutlineId || !selectedTextLesson) return;
    } else {
      // If standalone text presentation, check if prompt entered or coming from files/text/knowledge base
      if (!prompt.trim() && !isFromFiles && !isFromText && !isFromKnowledgeBase) return;
    }

    const params = new URLSearchParams();
    if (useExistingTextOutline === true && selectedTextOutlineId) {
      params.set("outlineId", String(selectedTextOutlineId));
    }
    if (useExistingTextOutline === true && selectedTextLesson) {
      params.set("lesson", selectedTextLesson);
      // Add course name (outline name) for proper course context
      if (selectedTextOutlineId && textOutlines.find(o => o.id === selectedTextOutlineId)) {
        const outline = textOutlines.find(o => o.id === selectedTextOutlineId);
        if (outline) {
          params.set("courseName", outline.name);
        }
      }
    }
    params.set("lang", textLanguage);
    params.set("length", textLength);
    params.set("styles", textStyles.join(','));
    
    // Handle different prompt sources
    if (isFromFiles) {
      const finalPrompt = prompt.trim() || "Create text presentation content from the provided files";
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromFiles", "true");
      if (folderIds.length > 0) params.set("folderIds", folderIds.join(','));
      if (fileIds.length > 0) params.set("fileIds", fileIds.join(','));
    } else if (isFromText) {
      const finalPrompt = prompt.trim() || (textMode === 'context' 
        ? "Create text presentation content using the provided text as context"
        : "Create text presentation content based on the provided text structure");
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromText", "true");
      params.set("textMode", textMode || 'context');
      // userText stays in sessionStorage - don't pass via URL
    } else if (isFromKnowledgeBase) {
      params.set("prompt", prompt.trim() || "Create text presentation content from the Knowledge Base");
      params.set("fromKnowledgeBase", "true");
    } else if (prompt.trim()) {
      const finalPrompt = prompt.trim();
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    router.push(`/create/text-presentation?${params.toString()}`);
  };

  const handleVideoLessonStart = () => {
    // Check if prompt entered or coming from files/text/knowledge base
    if (!prompt.trim() && !isFromFiles && !isFromText && !isFromKnowledgeBase) return;

    const params = new URLSearchParams();
    params.set("productType", "video_lesson_presentation"); // Flag to indicate video lesson with voiceover
    params.set("length", lengthRangeForOption(lengthOption));
    params.set("slidesCount", String(slidesCount));
    params.set("lang", language);
    
    // Handle different prompt sources
    if (isFromFiles) {
      const finalPrompt = prompt.trim() || "Create video lesson content from the provided files";
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromFiles", "true");
      if (folderIds.length > 0) params.set("folderIds", folderIds.join(','));
      if (fileIds.length > 0) params.set("fileIds", fileIds.join(','));
    } else if (isFromText) {
      const finalPrompt = prompt.trim() || (textMode === 'context' 
        ? "Create video lesson content using the provided text as context"
        : "Create video lesson content based on the provided text structure");
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
      params.set("fromText", "true");
      params.set("textMode", textMode || 'context');
      // userText stays in sessionStorage - don't pass via URL
    } else if (isFromKnowledgeBase) {
      params.set("prompt", prompt.trim() || "Create video lesson content from the Knowledge Base");
      params.set("fromKnowledgeBase", "true");
    } else if (prompt.trim()) {
      const finalPrompt = prompt.trim();
      // Store prompt in sessionStorage if it's long
      let promptReference = finalPrompt;
      if (finalPrompt.length > 500) {
        const promptId = generatePromptId();
        sessionStorage.setItem(promptId, finalPrompt);
        promptReference = promptId;
      }
      params.set("prompt", promptReference);
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    // Add connector context if coming from connectors
    if (connectorContext?.fromConnectors) {
      params.set("fromConnectors", "true");
      params.set("connectorIds", connectorContext.connectorIds.join(','));
      params.set("connectorSources", connectorContext.connectorSources.join(','));
    }

    router.push(`/create/lesson-presentation?${params.toString()}`);
  };

  return (
    <main
      className="min-h-screen flex flex-col items-center pt-24 pb-16 px-6"
      style={{
        background: `linear-gradient(135deg, var(--background-first) 0%, var(--background-second) 50%, var(--background-third) 100%)`
      }}
    >
      <div className="w-full max-w-3xl flex flex-col gap-6 items-center">
        {/* back button absolute top-left */}
        <Link
          href="/create"
          className="absolute top-6 left-6 flex items-center gap-2 text-sm text-gray-700 hover:text-gray-900 hover:bg-white/80 rounded-full px-4 py-2 border border-gray-200 bg-white/60 backdrop-blur-sm transition-all duration-200 shadow-sm hover:shadow-md"
        >
          <ArrowLeft size={16} /> {t('interface.generate.back', 'Back')}
        </Link>

        <h1 className="text-5xl font-semibold text-center tracking-wide text-[var(--primary)] mt-8">{t('interface.generate.title', 'Generate')}</h1>
        <p className="text-center text-[var(--secondary-foreground)] text-lg -mt-1">
          {isFromFiles ? t('interface.generate.subtitleFromFiles', 'Create content from your selected files') : 
           isFromText ? t('interface.generate.subtitleFromText', 'Create content from your text') : 
           isFromKnowledgeBase ? t('interface.generate.subtitleFromKnowledgeBase', 'Create content by searching your Knowledge Base') :
           isFromConnectors ? t('interface.generate.subtitleFromConnectors', 'Create content from your selected connectors') :
           t('interface.generate.subtitle', 'What would you like to create today?')}
        </p>

        {/* File context indicator */}
        {isFromFiles && (
          <Alert 
            className="backdrop-blur-sm shadow-sm"
            style={{
              backgroundColor: `rgb(var(--generate-alert-bg))`,
              borderColor: `rgb(var(--generate-alert-border))`,
              borderWidth: '1px'
            }}
          >
            <div 
              className="flex items-center gap-2 font-medium mb-2"
              style={{ color: `rgb(var(--generate-alert-text))` }}
            >
              <FileText className="h-5 w-5" />
              {t('interface.generate.creatingFromFiles', 'Creating from files')}
            </div>
            <AlertDescription style={{ color: `rgb(var(--generate-alert-text))` }}>
              {folderIds.length > 0 && (
                <p>{folderIds.length} {folderIds.length !== 1 ? t('interface.generate.foldersSelectedPlural', 'folders selected') : t('interface.generate.foldersSelected', 'folder selected')}</p>
              )}
              {fileIds.length > 0 && (
                <p>{fileIds.length} {fileIds.length !== 1 ? t('interface.generate.filesSelectedPlural', 'files selected') : t('interface.generate.filesSelected', 'file selected')}</p>
              )}
              <p className="mt-1 text-blue-600">
                {t('interface.generate.aiWillUseDocuments', 'The AI will use your selected documents as source material to create educational content.')}
              </p>
            </AlertDescription>
          </Alert>
        )}

        {/* Text context indicator */}
        {isFromText && (
          <Alert className="w-full max-w-3xl bg-gradient-to-l from-[#00BBFF66]/40 to-[#00BBFF66]/10 backdrop-blur-sm border border-gray-100/50 shadow-md">
            <AlertDescription className="text-blue-600">
              <div className="flex items-center gap-2 text-blue-600 mb-2">
                <FileText className="h-6 w-6" />
                <span className="text-lg font-semibold">{t('interface.generate.creatingFromText', 'Creating from text')}</span>
              </div>
              <p className="font-medium text-gray-500">
                {textMode === 'context' ? t('interface.generate.modeUsingAsContext', 'Mode: Using as context') : t('interface.generate.modeUsingAsBaseStructure', 'Mode: Using as base structure')}
              </p>
              <p className="mt-1 text-gray-500">
                {textMode === 'context' 
                  ? t('interface.generate.aiWillUseTextAsContext', 'The AI will use your text as reference material and context to create new educational content.')
                  : t('interface.generate.aiWillBuildUponText', 'The AI will build upon your existing content structure, enhancing and formatting it into a comprehensive educational product.')}
              </p>
            </AlertDescription>
          </Alert>
        )}

        {/* Knowledge Base context indicator */}
        {isFromKnowledgeBase && (
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6 shadow-sm">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-10 h-10 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-xl flex items-center justify-center">
                <Search className="h-5 w-5 text-blue-600" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-blue-900">
                  {t('interface.generate.creatingFromKnowledgeBase', 'Creating from Knowledge Base')}
                </h3>
                <p className="text-sm text-blue-700 mt-1">
                  {t('interface.generate.aiWillSearchKnowledgeBase', 'The AI will search your entire Knowledge Base to find relevant information and create educational content.')}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Connector context indicator */}
        {isFromConnectors && connectorContext && (
          <div className="w-full max-w-3xl bg-gradient-to-l from-[#00BBFF66]/40 to-[#00BBFF66]/10 border-2 border-[#CCF1FF] rounded-xl p-6 mb-6 shadow-md">
            <div className="flex items-center gap-3 mb-3">
                <Network className="h-10 w-10 text-blue-600" />
              <div>
                <h3 className="text-lg font-semibold text-blue-600">
                  {t('interface.generate.creatingFromConnectors', 'Creating from Selected Connectors')}
                </h3>
                <p className="text-sm text-gray-500 mt-1">
                  {t('interface.generate.aiWillUseConnectorData', 'The AI will use data from your selected connectors to create educational content.')}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Knowledge Base context indicator */}
        {isFromKnowledgeBase && (
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6 shadow-sm">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-10 h-10 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-xl flex items-center justify-center">
                <Search className="h-5 w-5 text-blue-600" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-blue-900">
                  {t('interface.generate.creatingFromKnowledgeBase', 'Creating from Knowledge Base')}
                </h3>
                <p className="text-sm text-blue-700 mt-1">
                  {t('interface.generate.aiWillSearchKnowledgeBase', 'The AI will search your entire Knowledge Base to find relevant information and create educational content.')}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Connector context indicator */}
        {isFromConnectors && connectorContext && (
          <div className="w-full max-w-3xl bg-gradient-to-l from-[#00BBFF66]/40 to-[#00BBFF66]/10 border-2 border-[#CCF1FF] rounded-xl p-6 mb-6 shadow-sm">
            <div className="flex items-center gap-3 mb-3">
               <Network className="h-10 w-10 text-blue-600" />
              <div>
                <h3 className="text-lg font-semibold text-blue-600">
                  {t('interface.generate.creatingFromConnectors', 'Creating from Selected Connectors')}
                </h3>
                <p className="text-sm text-gray-500 mt-1">
                  {t('interface.generate.aiWillUseConnectorData', 'The AI will use data from your selected connectors to create educational content.')}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Tab selector */}
        <div className="w-full max-w-5xl grid grid-cols-5 gap-2 sm:gap-2 md:gap-3 lg:gap-3 mb-1 justify-items-center backdrop-blur-md bg-white/20 border border-white/30 rounded-xl p-5 shadow-lg transition-all duration-200 hover:shadow-xl">
          <GenerateCard
            label={t('interface.generate.courseOutline', 'Course')}
            Icon={CourseOutlineIcon}
            active={activeProduct === "Course"}
            onClick={() => setActiveProduct("Course")}
          />
          <GenerateCard 
            label={t('interface.generate.videoLesson', 'Video Lesson')} 
            Icon={VideoScriptIcon}
            active={activeProduct === "Video Lesson"}
            onClick={() => setActiveProduct("Video Lesson")}
          />
          <GenerateCard 
            label={t('interface.generate.quiz', 'Quiz')} 
            Icon={QuizIcon}
            active={activeProduct === "Quiz"}
            onClick={() => setActiveProduct("Quiz")}
          />
          <GenerateCard
            label={t('interface.generate.presentation', 'Presentation')}
            Icon={LessonPresentationIcon}
            active={activeProduct === "Presentation"}
            onClick={() => setActiveProduct("Presentation")}
          />
          <GenerateCard
            label={t('interface.generate.onePager', 'One-Pager')}
            Icon={TextPresentationIcon}
            active={activeProduct === "One-Pager"}
            onClick={() => setActiveProduct("One-Pager")}
          />
        </div>

        {/* Dropdown chips */}
        {activeProduct === "Course" && (
          <div className="flex flex-wrap justify-center gap-4">
            <CustomPillSelector
              value={modulesCount.toString()}
              onValueChange={(value) => setModulesCount(Number(value))}
              options={Array.from({ length: 10 }, (_, i) => ({
                value: (i + 1).toString(),
                label: `${i + 1} ${i === 0 ? t('interface.generate.module', 'module') : t('interface.generate.modulesLowercase', 'modules')}`
              }))}
              icon={<FolderIcon className="w-4 h-4 text-gray-500" />}
              label={t('interface.generate.modules', 'Modules')}
            />
            <CustomPillSelector
              value={lessonsPerModule}
              onValueChange={setLessonsPerModule}
              options={["1-2", "3-4", "5-7", "8-10"].map((rng) => ({
                value: `${rng} ${t('interface.generate.perModule', 'per module')}`,
                label: `${rng} ${t('interface.generate.perModule', 'per module')}`
              }))}
              icon={<FileText className="w-4 h-4 text-gray-500" />}
              label={t('interface.generate.lessons', 'Lessons')}
            />
            <CustomPillSelector
              value={language}
              onValueChange={setLanguage}
              options={[
                { value: "English", label: t('interface.english', 'English') },
                { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                { value: "Russian", label: t('interface.russian', 'Russian') }
              ]}
              icon={<Globe className="w-4 h-4 text-gray-500" />}
              label={t('interface.language', 'Language')}
            />
          </div>
        )}

        {activeProduct === "Presentation" && useExistingOutline !== null && (
          <div className="flex flex-wrap justify-center gap-4">
                {/* Show outline flow if user chose existing outline */}
                {useExistingOutline === true && (
                  <>
                    {/* Outline dropdown */}
                    <CustomPillSelector
                      value={selectedOutlineId !== null ? outlines.find(o => o.id === selectedOutlineId)?.name ?? "" : ""}
                      onValueChange={(value) => {
                        const outline = outlines.find(o => o.name === value);
                        setSelectedOutlineId(outline ? outline.id : null);
                        // clear module & lesson selections when outline changes
                        setSelectedModuleIndex(null);
                        setLessonsForModule([]);
                        setSelectedLesson("");
                      }}
                      options={outlines.map((o) => ({
                        value: o.name,
                        label: o.name
                      }))}
                      icon={<ClipboardList className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.courseOutline', 'Outline')}
                    />

                    {/* Module dropdown â€“ appears once outline is selected */}
                    {selectedOutlineId && (
                      <CustomPillSelector
                        value={selectedModuleIndex !== null ? modulesForOutline[selectedModuleIndex]?.name ?? "" : ""}
                        onValueChange={(value) => {
                          const idx = modulesForOutline.findIndex(m => m.name === value);
                          setSelectedModuleIndex(idx !== -1 ? idx : null);
                          setLessonsForModule(idx !== -1 ? modulesForOutline[idx].lessons : []);
                          setSelectedLesson("");
                        }}
                        options={modulesForOutline.map((m, idx) => ({
                          value: m.name,
                          label: m.name
                        }))}
                        icon={<FolderIcon className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.module', 'Module')}
                      />
                    )}

                    {/* Lesson dropdown â€“ appears when module chosen */}
                    {selectedModuleIndex !== null && (
                      <CustomPillSelector
                        value={selectedLesson}
                        onValueChange={setSelectedLesson}
                        options={lessonsForModule.map((l) => ({
                          value: l,
                          label: l
                        }))}
                        icon={<FileText className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.lesson', 'Lesson')}
                      />
                    )}

                    {/* Show final dropdowns when lesson is selected */}
                    {selectedLesson && (
                      <>
                        <CustomPillSelector
                          value={language}
                          onValueChange={setLanguage}
                          options={[
                            { value: "English", label: t('interface.english', 'English') },
                            { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                            { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                            { value: "Russian", label: t('interface.russian', 'Russian') }
                          ]}
                          icon={<Globe className="w-4 h-4 text-gray-500" />}
                          label={t('interface.language', 'Language')}
                        />
                        <CustomPillSelector
                          value={slidesCount.toString()}
                          onValueChange={(value) => setSlidesCount(Number(value))}
                          options={Array.from({ length: 14 }, (_, i) => ({
                            value: (i + 2).toString(),
                            label: `${i + 2} ${i === 0 ? t('interface.generate.slide', 'slide') : t('interface.generate.slidesLowercase', 'slides')}`
                          }))}
                          icon={<PanelsLeftBottom className="w-4 h-4 text-gray-500" />}
                          label={t('interface.generate.slides', 'Slides')}
                        />
                      </>
                    )}
                  </>
                )}

                {/* Show standalone presentation dropdowns if user chose standalone */}
                {useExistingOutline === false && (
                  <>
                    <CustomPillSelector
                      value={language}
                      onValueChange={setLanguage}
                      options={[
                        { value: "English", label: t('interface.english', 'English') },
                        { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                        { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                        { value: "Russian", label: t('interface.russian', 'Russian') }
                      ]}
                      icon={<Globe className="w-4 h-4 text-gray-500" />}
                      label={t('interface.language', 'Language')}
                    />
                    <CustomPillSelector
                      value={slidesCount.toString()}
                      onValueChange={(value) => setSlidesCount(Number(value))}
                      options={Array.from({ length: 14 }, (_, i) => ({
                        value: (i + 2).toString(),
                        label: `${i + 2} ${i === 0 ? t('interface.generate.slide', 'slide') : t('interface.generate.slidesLowercase', 'slides')}`
                      }))}
                      icon={<PanelsLeftBottom className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.slides', 'Slides')}
                    />
                  </>
                )}
          </div>
        )}

        {/* Quiz Configuration */}
        {activeProduct === "Quiz" && useExistingQuizOutline !== null && (
          <div className="flex flex-wrap justify-center gap-4">
                {/* Back button at the start of the section */}
                {/* <Button
                  onClick={() => {
                    setUseExistingQuizOutline(null);
                    setSelectedQuizOutlineId(null);
                    setSelectedQuizModuleIndex(null);
                    setQuizLessonsForModule([]);
                    setSelectedQuizLesson("");
                  }}
                  variant="outline"
                  size="sm"
                  className="px-4 py-2 rounded-full border border-gray-300 bg-white/90 text-sm text-gray-500 hover:bg-gray-100"
                >
                  â† Back
                </Button> */}
                
                {/* Show outline flow if user chose existing outline */}
                {useExistingQuizOutline === true && (
                  <>
                    {/* Outline dropdown */}
                    <CustomPillSelector
                      value={selectedQuizOutlineId !== null ? quizOutlines.find(o => o.id === selectedQuizOutlineId)?.name ?? "" : ""}
                      onValueChange={(value) => {
                        const outline = quizOutlines.find(o => o.name === value);
                        setSelectedQuizOutlineId(outline ? outline.id : null);
                        // clear module & lesson selections when outline changes
                        setSelectedQuizModuleIndex(null);
                        setQuizLessonsForModule([]);
                        setSelectedQuizLesson("");
                      }}
                      options={quizOutlines.map((outline) => ({
                        value: outline.name,
                        label: outline.name
                      }))}
                      icon={<ClipboardList className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.courseOutline', 'Outline')}
                    />

                    {/* Module dropdown â€“ appears once outline is selected */}
                    {selectedQuizOutlineId && (
                      <CustomPillSelector
                        value={selectedQuizModuleIndex !== null ? quizModulesForOutline[selectedQuizModuleIndex]?.name ?? "" : ""}
                        onValueChange={(value) => {
                          const idx = quizModulesForOutline.findIndex(m => m.name === value);
                          setSelectedQuizModuleIndex(idx !== -1 ? idx : null);
                          setQuizLessonsForModule(idx !== -1 ? quizModulesForOutline[idx].lessons : []);
                          setSelectedQuizLesson("");
                        }}
                        options={quizModulesForOutline.map((m, idx) => ({
                          value: m.name,
                          label: m.name
                        }))}
                        icon={<FolderIcon className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.module', 'Module')}
                      />
                    )}

                    {/* Lesson dropdown â€“ appears when module chosen */}
                    {selectedQuizModuleIndex !== null && (
                      <CustomPillSelector
                        value={selectedQuizLesson}
                        onValueChange={setSelectedQuizLesson}
                        options={quizLessonsForModule.map((l) => ({
                          value: l,
                          label: l
                        }))}
                        icon={<FileText className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.lesson', 'Lesson')}
                      />
                    )}

                    {/* Show final dropdowns when lesson is selected */}
                    {selectedQuizLesson && (
                      <>
                        <CustomPillSelector
                          value={quizLanguage}
                          onValueChange={setQuizLanguage}
                          options={[
                            { value: "English", label: t('interface.english', 'English') },
                            { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                            { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                            { value: "Russian", label: t('interface.russian', 'Russian') }
                          ]}
                          icon={<Globe className="w-4 h-4 text-gray-500" />}
                          label={t('interface.language', 'Language')}
                        />
                        <CustomMultiSelector
                          selectedValues={selectedQuestionTypes}
                          onSelectionChange={setSelectedQuestionTypes}
                          options={[
                            { value: "multiple-choice", label: t('interface.generate.multipleChoice', 'Multiple Choice') },
                            { value: "multi-select", label: t('interface.generate.multiSelect', 'Multiple Select') },
                            { value: "matching", label: t('interface.generate.matching', 'Matching') },
                            { value: "sorting", label: t('interface.generate.sorting', 'Sorting') },
                            { value: "open-answer", label: t('interface.generate.openAnswer', 'Open Answer') }
                          ]}
                          icon={<FileQuestion className="w-4 h-4 text-gray-500" />}
                          label={t('interface.generate.questionTypes', 'Question Types')}
                          placeholder={t('interface.generate.selectQuestionTypes', 'Select Question Types')}
                        />
                        <CustomPillSelector
                          value={quizQuestionCount.toString()}
                          onValueChange={(value) => setQuizQuestionCount(Number(value))}
                          options={[5, 10, 15, 20, 25, 30].map((count) => ({
                            value: count.toString(),
                            label: `${count} ${count === 1 ? t('interface.generate.question', 'question') : t('interface.generate.questionsLowercase', 'questions')}`
                          }))}
                          icon={<MessageCircleQuestion className="w-4 h-4 text-gray-500" />}
                          label={t('interface.generate.questions', 'Questions')}
                        />
                      </>
                    )}
                  </>
                )}

                {/* Show standalone quiz dropdowns if user chose standalone */}
                {useExistingQuizOutline === false && (
                  <>
                    <CustomPillSelector
                      value={quizLanguage}
                      onValueChange={setQuizLanguage}
                      options={[
                        { value: "English", label: t('interface.english', 'English') },
                        { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                        { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                        { value: "Russian", label: t('interface.russian', 'Russian') }
                      ]}
                      icon={<Globe className="w-4 h-4 text-gray-500" />}
                      label={t('interface.language', 'Language')}
                    />
                    <CustomMultiSelector
                      selectedValues={selectedQuestionTypes}
                      onSelectionChange={setSelectedQuestionTypes}
                      options={[
                        { value: "multiple-choice", label: t('interface.generate.multipleChoice', 'Multiple Choice') },
                        { value: "multi-select", label: t('interface.generate.multiSelect', 'Multiple Select') },
                        { value: "matching", label: t('interface.generate.matching', 'Matching') },
                        { value: "sorting", label: t('interface.generate.sorting', 'Sorting') },
                        { value: "open-answer", label: t('interface.generate.openAnswer', 'Open Answer') }
                      ]}
                      icon={<FileQuestion className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.questionTypes', 'Question Types')}
                      placeholder={t('interface.generate.selectQuestionTypes', 'Select Question Types')}
                    />
                    <CustomPillSelector
                      value={quizQuestionCount.toString()}
                      onValueChange={(value) => setQuizQuestionCount(Number(value))}
                      options={[5, 10, 15, 20, 25, 30].map((count) => ({
                        value: count.toString(),
                        label: `${count} ${count === 1 ? t('interface.generate.question', 'question') : t('interface.generate.questionsLowercase', 'questions')}`
                      }))}
                      icon={<MessageCircleQuestion className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.questions', 'Questions')}
                    />
                  </>
                )}
          </div>
        )}

        {/* One-Pager Configuration */}
        {activeProduct === "One-Pager" && useExistingTextOutline !== null && (
          <div className="flex flex-wrap justify-center gap-4">
                {/* Back button at the start of the section */}
                {/* <Button
                  onClick={() => {
                    setUseExistingTextOutline(null);
                    setSelectedTextOutlineId(null);
                    setSelectedTextModuleIndex(null);
                    setTextLessonsForModule([]);
                    setSelectedTextLesson("");
                  }}
                  variant="outline"
                  size="sm"
                  className="px-4 py-2 rounded-full border border-gray-300 bg-white/90 text-sm text-gray-500 hover:bg-gray-100"
                >
                  â† Back
                </Button> */}
                
                {/* Show outline flow if user chose existing outline */}
                {useExistingTextOutline === true && (
                  <>
                    {/* Outline dropdown */}
                    <CustomPillSelector
                      value={selectedTextOutlineId !== null ? textOutlines.find(o => o.id === selectedTextOutlineId)?.name ?? "" : ""}
                      onValueChange={(value) => {
                        const outline = textOutlines.find(o => o.name === value);
                        setSelectedTextOutlineId(outline ? outline.id : null);
                        // clear module & lesson selections when outline changes
                        setSelectedTextModuleIndex(null);
                        setTextLessonsForModule([]);
                        setSelectedTextLesson("");
                      }}
                      options={textOutlines.map((o) => ({
                        value: o.name,
                        label: o.name
                      }))}
                      icon={<ClipboardList className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.courseOutline', 'Outline')}
                    />

                    {/* Module dropdown â€“ appears once outline is selected */}
                    {selectedTextOutlineId && (
                      <CustomPillSelector
                        value={selectedTextModuleIndex !== null ? textModulesForOutline[selectedTextModuleIndex]?.name ?? "" : ""}
                        onValueChange={(value) => {
                          const idx = textModulesForOutline.findIndex(m => m.name === value);
                          setSelectedTextModuleIndex(idx !== -1 ? idx : null);
                          setTextLessonsForModule(idx !== -1 ? textModulesForOutline[idx].lessons : []);
                          setSelectedTextLesson("");
                        }}
                        options={textModulesForOutline.map((m, idx) => ({
                          value: m.name,
                          label: m.name
                        }))}
                        icon={<FolderIcon className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.module', 'Module')}
                      />
                    )}

                    {/* Lesson dropdown â€“ appears when module chosen */}
                    {selectedTextModuleIndex !== null && (
                      <CustomPillSelector
                        value={selectedTextLesson}
                        onValueChange={setSelectedTextLesson}
                        options={textLessonsForModule.map((l) => ({
                          value: l,
                          label: l
                        }))}
                        icon={<FileText className="w-4 h-4 text-gray-500" />}
                        label={t('interface.generate.lesson', 'Lesson')}
                      />
                    )}

                    {/* Show final dropdowns when lesson is selected */}
                    {selectedTextLesson && (
                      <>
                        <CustomPillSelector
                          value={textLanguage}
                          onValueChange={setTextLanguage}
                          options={[
                            { value: "English", label: t('interface.english', 'English') },
                            { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                            { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                            { value: "Russian", label: t('interface.russian', 'Russian') }
                          ]}
                          icon={<Globe className="w-4 h-4 text-gray-500" />}
                          label={t('interface.language', 'Language')}
                        />
                        <CustomPillSelector
                          value={textLength}
                          onValueChange={setTextLength}
                          options={[
                            { value: "Short", label: t('interface.generate.short', 'Short') },
                            { value: "Medium", label: t('interface.generate.medium', 'Medium') },
                            { value: "Long", label: t('interface.generate.long', 'Long') }
                          ]}
                          icon={<RulerDimensionLine className="w-4 h-4 text-gray-500" />}
                          label={t('interface.generate.length', 'Length')}
                        />
                        <CustomMultiSelector
                          selectedValues={textStyles}
                          onSelectionChange={setTextStyles}
                          options={[
                            { value: "headlines", label: t('interface.generate.headlines', 'Headlines'), tooltip: stylePurposes.headlines },
                            { value: "paragraphs", label: t('interface.generate.paragraphs', 'Paragraphs'), tooltip: stylePurposes.paragraphs },
                            { value: "bullet_lists", label: t('interface.generate.bulletLists', 'Bullet Lists'), tooltip: stylePurposes.bullet_lists },
                            { value: "numbered_lists", label: t('interface.generate.numberedLists', 'Numbered Lists'), tooltip: stylePurposes.numbered_lists },
                            { value: "alerts", label: t('interface.generate.alerts', 'Alerts'), tooltip: stylePurposes.alerts },
                            { value: "recommendations", label: t('interface.generate.recommendations', 'Recommendations'), tooltip: stylePurposes.recommendations },
                            { value: "section_breaks", label: t('interface.generate.sectionBreaks', 'Section Breaks'), tooltip: stylePurposes.section_breaks },
                            { value: "icons", label: t('interface.generate.icons', 'Icons'), tooltip: stylePurposes.icons },
                            { value: "important_sections", label: t('interface.generate.importantSections', 'Important Sections'), tooltip: stylePurposes.important_sections }
                          ]}
                          icon={<Paintbrush className="w-4 h-4 text-gray-500" />}
                          label={t('interface.generate.styles', 'Styles')}
                          placeholder={t('interface.generate.selectStyles', 'Select styles')}
                        />
                      </>
                    )}
                  </>
                )}

                {/* Show standalone one-pager dropdowns if user chose standalone */}
                {useExistingTextOutline === false && (
                  <>
                    <CustomPillSelector
                      value={textLanguage}
                      onValueChange={setTextLanguage}
                      options={[
                        { value: "English", label: t('interface.english', 'English') },
                        { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                        { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                        { value: "Russian", label: t('interface.russian', 'Russian') }
                      ]}
                      icon={<Globe className="w-4 h-4 text-gray-500" />}
                      label={t('interface.language', 'Language')}
                    />
                    <CustomPillSelector
                      value={textLength}
                      onValueChange={setTextLength}
                      options={[
                        { value: "Short", label: t('interface.generate.short', 'Short') },
                        { value: "Medium", label: t('interface.generate.medium', 'Medium') },
                        { value: "Long", label: t('interface.generate.long', 'Long') }
                      ]}
                      icon={<RulerDimensionLine className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.length', 'Length')}
                    />
                    <CustomMultiSelector
                      selectedValues={textStyles}
                      onSelectionChange={setTextStyles}
                      options={[
                        { value: "headlines", label: t('interface.generate.headlines', 'Headlines'), tooltip: stylePurposes.headlines },
                        { value: "paragraphs", label: t('interface.generate.paragraphs', 'Paragraphs'), tooltip: stylePurposes.paragraphs },
                        { value: "bullet_lists", label: t('interface.generate.bulletLists', 'Bullet Lists'), tooltip: stylePurposes.bullet_lists },
                        { value: "numbered_lists", label: t('interface.generate.numberedLists', 'Numbered Lists'), tooltip: stylePurposes.numbered_lists },
                        { value: "alerts", label: t('interface.generate.alerts', 'Alerts'), tooltip: stylePurposes.alerts },
                        { value: "recommendations", label: t('interface.generate.recommendations', 'Recommendations'), tooltip: stylePurposes.recommendations },
                        { value: "section_breaks", label: t('interface.generate.sectionBreaks', 'Section Breaks'), tooltip: stylePurposes.section_breaks },
                        { value: "icons", label: t('interface.generate.icons', 'Icons'), tooltip: stylePurposes.icons },
                        { value: "important_sections", label: t('interface.generate.importantSections', 'Important Sections'), tooltip: stylePurposes.important_sections }
                      ]}
                      icon={<Paintbrush className="w-4 h-4 text-gray-500" />}
                      label={t('interface.generate.styles', 'Styles')}
                      placeholder={t('interface.generate.selectStyles', 'Select styles')}
                    />
                  </>
                )}
          </div>
        )}

        {/* Video Lesson Configuration */}
        {activeProduct === "Video Lesson" && (
          <div className="flex flex-wrap justify-center gap-4">
            <CustomPillSelector
              value={slidesCount.toString()}
              onValueChange={(value) => setSlidesCount(Number(value))}
              options={[3, 4, 5, 6, 7, 8, 9, 10, 12, 15].map((count) => ({
                value: count.toString(),
                label: `${count} ${count === 1 ? t('interface.generate.slide', 'slide') : t('interface.generate.slidesLowercase', 'slides')}`
              }))}
              icon={<PanelsLeftBottom className="w-4 h-4 text-gray-500" />}
              label={t('interface.generate.slides', 'Slides')}
            />
            <CustomPillSelector
              value={language}
              onValueChange={setLanguage}
              options={[
                { value: "English", label: t('interface.english', 'English') },
                { value: "Ukrainian", label: t('interface.ukrainian', 'Ukrainian') },
                { value: "Spanish", label: t('interface.spanish', 'Spanish') },
                { value: "Russian", label: t('interface.russian', 'Russian') }
              ]}
              icon={<Globe className="w-4 h-4 text-gray-500" />}
              label={t('interface.language', 'Language')}
            />
          </div>
        )}

        {/* Prompt Input Area - shown for standalone products or when no outline is selected */}
        {((activeProduct === "Course") || 
          (activeProduct === "Video Lesson") ||
          (activeProduct === "One-Pager" && useExistingTextOutline === false) ||
          (activeProduct === "Quiz" && useExistingQuizOutline === false) ||
          (activeProduct === "Presentation" && useExistingOutline === false)) && (
          <div className="flex flex-col items-center gap-3 w-full max-w-3xl">
            {/* Simple prompt input */}
            <div className="w-full relative">
            <Textarea
              ref={promptRef}
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder={isFromKnowledgeBase 
                ? t('interface.generate.knowledgeBasePromptPlaceholder', 'Enter a topic or question to search your Knowledge Base')
                : t('interface.generate.promptPlaceholder', 'Describe what you\'d like to make')}
              className="w-full px-7 py-5 rounded-md bg-white shadow-lg text-lg text-black resize-none overflow-hidden min-h-[140px] max-h-[320px] border border-[var(--border)] focus:border-[var(--ring)] focus:outline-none transition-colors placeholder-[var(--muted-foreground)] relative z-10 transition-all duration-200 hover:shadow-xl"
              style={{ background: "rgba(255,255,255,0.95)" }}
              rows={6}
            />
            </div>

            {/* Simple examples grid */}
            <div className={`w-full mt-5 transition-all duration-300 ${prompt.trim() ? 'opacity-0 pointer-events-none max-h-0 overflow-hidden' : 'opacity-100 max-h-screen'}`}>
            <div className="w-full relative z-0">
              <div className="flex items-center justify-center mb-2 relative">
                <div className="absolute left-0 right-0 top-1/2 -translate-y-1/2 flex items-center" aria-hidden="true">
                  <div className="flex-1 border-t border-blue-100"></div>
                </div>
                <span className="relative z-10 bg-transparent px-4 text-lg font-semibold text-blue-900 text-center" style={{ letterSpacing: 0 }}>
                  {t('interface.generate.examplePrompts', 'Example prompts')}
                </span>
              </div>
              <div className="grid grid-rows-2 sm:grid-cols-3 grid-flow-col gap-2">
                {Array.from({ length: 6 }).map((_, index) =>
                  examples[index] ? (
                    <button
                      key={index}
                      onClick={() => setPrompt(examples[index])}
                      className="flex flex-col justify-center items-center w-full px-3 py-2 rounded-full backdrop-blur-md bg-white/20 border border-white/30 hover:bg-white/40 transition-all duration-200 text-sm font-medium text-gray-500 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-200 relative cursor-pointer"
                      style={{ minHeight: 56 }}
                    >
                      <span className="text-center leading-tight pr-6">{examples[index]}</span>
                      <span className="absolute top-3 right-3 text-gray-500 text-lg font-semibold">+</span>
                    </button>
                  ) : (
                    <div key={index} className="w-full px-3 py-2 rounded-full bg-transparent" />
                  )
                )}
              </div>
              <div className="flex justify-center mt-3">
                <Button
                  onClick={shuffleExamples}
                  variant="blueGradient"
                  className="flex items-center gap-2 px-6 py-2 rounded-full text-base font-medium"
                >
                  <Shuffle size={18} /> {t('interface.generate.shuffleExamples', 'Shuffle')}
                </Button>
              </div>
            </div>
          </div>
          </div>
        )}

        {/* Generate Button */}
        {((activeProduct === "Course" && (prompt.trim() || isFromFiles || isFromText || isFromKnowledgeBase || isFromConnectors)) ||
          (activeProduct === "Video Lesson" && (prompt.trim() || isFromFiles || isFromText || isFromKnowledgeBase || isFromConnectors)) ||
          (activeProduct === "One-Pager" && useExistingTextOutline === true && selectedTextOutlineId && selectedTextLesson) ||
          (activeProduct === "One-Pager" && useExistingTextOutline === false && (prompt.trim() || isFromFiles || isFromText || isFromKnowledgeBase || isFromConnectors)) ||
          (activeProduct === "Quiz" && useExistingQuizOutline === true && selectedQuizOutlineId && selectedQuizLesson) ||
          (activeProduct === "Quiz" && useExistingQuizOutline === false && (prompt.trim() || isFromFiles || isFromText || isFromKnowledgeBase || isFromConnectors)) ||
          (activeProduct === "Presentation" && useExistingOutline === true && selectedOutlineId && selectedLesson) ||
          (activeProduct === "Presentation" && useExistingOutline === false && (prompt.trim() || isFromFiles || isFromText || isFromKnowledgeBase || isFromConnectors))) && (
          <div className="flex justify-center mt-3 mb-4">
            <Button
              onClick={() => {
                switch (activeProduct) {
                  case "Course":
                    handleCourseOutlineStart();
                    break;
                  case "Video Lesson":
                    handleVideoLessonStart();
                    break;
                  case "One-Pager":
                    handleTextPresentationStart();
                    break;
                  case "Quiz":
                    handleQuizStart();
                    break;
                  case "Presentation":
                    handleSlideDeckStart();
                    break;
                }
              }}
              size="lg"
              className="flex items-center gap-2 px-10 py-4 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold shadow transition-colors"
              style={{ minWidth: 240 }}
            >
              <Sparkles size={20} />
              {activeProduct === "Course" && t('interface.generate.generateCourseOutline', 'Generate Course')}
              {activeProduct === "Video Lesson" && t('interface.generate.generateVideoLesson', 'Generate Video Lesson')}
              {activeProduct === "Presentation" && t('interface.generate.generatePresentation', 'Generate Presentation')}
              {activeProduct === "Quiz" && t('interface.generate.generateQuiz', 'Generate Quiz')}
              {activeProduct === "One-Pager" && t('interface.generate.generateOnePager', 'Generate One-Pager')}
            </Button>
          </div>
        )}
        </div> {/* close inner flex container */}
    </main>
  );
}

export default function GeneratePage() {
  const { t } = useLanguage();
  
  return (
    <Suspense fallback={<div>{t('interface.generate.loading', 'Loading...')}</div>}>
      <GenerateProductPicker />
    </Suspense>
  );
}